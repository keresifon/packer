name: Test Validation Only

on:
  workflow_dispatch:
    inputs:
      ami_id:
        description: 'AMI ID to validate'
        required: true
        type: string
      aws_region:
        description: 'AWS region'
        required: false
        default: 'us-east-1'
        type: string

env:
  PKR_VAR_aws_region: ${{ github.event.inputs.aws_region || 'us-east-1' }}
  # VPC Configuration from GitHub Variables/Secrets
  PKR_VAR_vpc_id: ${{ vars.VPC_ID || secrets.VPC_ID || '' }}
  PKR_VAR_subnet_id: ${{ vars.SUBNET_ID || secrets.SUBNET_ID || '' }}
  SECURITY_GROUP_IDS: ${{ vars.SECURITY_GROUP_IDS || secrets.SECURITY_GROUP_IDS || '' }}
  PKR_VAR_iam_instance_profile: ${{ vars.IAM_INSTANCE_PROFILE || secrets.IAM_INSTANCE_PROFILE || '' }}
  # AWS Credentials from GitHub Secrets
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}

jobs:
  test-validation:
    name: Test AMI Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          AWS_DEFAULT_REGION: ${{ env.PKR_VAR_aws_region }}
        run: |
          if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
            echo "❌ ERROR: AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY must be set as GitHub secrets"
            exit 1
          fi
          echo "✅ AWS credentials configured"
          aws sts get-caller-identity || (echo "❌ ERROR: Failed to authenticate with AWS" && exit 1)

      - name: Install Ansible and SSM plugin
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install ansible
          pip3 install boto3 botocore
          ansible-galaxy collection install community.aws amazon.aws
          ansible --version

      - name: Verify AWS CLI is available
        run: |
          aws --version || (echo "AWS CLI not found, installing..." && \
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && \
            unzip -q awscliv2.zip && \
            sudo ./aws/install --update && \
            rm -rf aws awscliv2.zip)
          aws --version

      - name: Install yq for config parsing
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Read build configuration for validation
        id: config-validation
        run: |
          CONFIG_FILE="config/build-config.yml"
          VALIDATION_INSTANCE_TYPE=$(yq eval '.instance.validation_instance_type' "$CONFIG_FILE" || echo "t3.micro")
          VALIDATION_CIS_LEVEL=$(yq eval '.cis.validation_level' "$CONFIG_FILE" || echo "2")
          VALIDATION_CIS_THRESHOLD=$(yq eval '.cis.validation_threshold' "$CONFIG_FILE" || echo "80")
          VALIDATION_FAIL_ON_FAILURE=$(yq eval '.cis.validation_fail_on_failure' "$CONFIG_FILE" || echo "false")
          
          VPC_ID="${PKR_VAR_vpc_id:-$(yq eval '.vpc.vpc_id' "$CONFIG_FILE" || echo '')}"
          SUBNET_ID="${PKR_VAR_subnet_id:-$(yq eval '.vpc.subnet_id' "$CONFIG_FILE" || echo '')}"
          IAM_INSTANCE_PROFILE="${PKR_VAR_iam_instance_profile:-$(yq eval '.vpc.iam_instance_profile' "$CONFIG_FILE" || echo '')}"
          SECURITY_GROUP_IDS="${SECURITY_GROUP_IDS:-$(yq eval '.vpc.security_group_ids[]' "$CONFIG_FILE" | tr '\n' ',' | sed 's/,$//' || echo '')}"
          
          echo "validation_instance_type=$VALIDATION_INSTANCE_TYPE" >> $GITHUB_OUTPUT
          echo "validation_cis_level=$VALIDATION_CIS_LEVEL" >> $GITHUB_OUTPUT
          echo "validation_cis_threshold=$VALIDATION_CIS_THRESHOLD" >> $GITHUB_OUTPUT
          echo "validation_fail_on_failure=$VALIDATION_FAIL_ON_FAILURE" >> $GITHUB_OUTPUT
          echo "validation_vpc_id=$VPC_ID" >> $GITHUB_OUTPUT
          echo "validation_subnet_id=$SUBNET_ID" >> $GITHUB_OUTPUT
          echo "validation_iam_instance_profile=$IAM_INSTANCE_PROFILE" >> $GITHUB_OUTPUT
          echo "validation_security_group_ids=$SECURITY_GROUP_IDS" >> $GITHUB_OUTPUT

      - name: Create security group for validation instance
        id: create-sg
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          AWS_DEFAULT_REGION: ${{ env.PKR_VAR_aws_region }}
        run: |
          VPC_ID="${{ steps.config-validation.outputs.validation_vpc_id }}"
          
          if [ -z "$VPC_ID" ] || [ "$VPC_ID" = "" ]; then
            echo "⚠️  WARNING: VPC ID not set. Creating security group in default VPC."
            VPC_ID=$(aws ec2 describe-vpcs --filters "Name=isDefault,Values=true" --query 'Vpcs[0].VpcId' --output text --region ${{ env.PKR_VAR_aws_region }})
          fi
          
          SG_NAME="packer-validation-test-$(date +%s)"
          SG_ID=$(aws ec2 create-security-group \
            --group-name "$SG_NAME" \
            --description "Temporary security group for AMI validation test (SSM Session Manager)" \
            --vpc-id "$VPC_ID" \
            --region ${{ env.PKR_VAR_aws_region }} \
            --query 'GroupId' \
            --output text)
          
          echo "Security group created: $SG_ID (SSM Session Manager - no inbound rules needed)"
          echo "sg_id=$SG_ID" >> $GITHUB_OUTPUT

      - name: Launch test instance
        id: launch-instance
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          AWS_DEFAULT_REGION: ${{ env.PKR_VAR_aws_region }}
        run: |
          AMI_ID="${{ github.event.inputs.ami_id }}"
          SG_ID="${{ steps.create-sg.outputs.sg_id }}"
          INSTANCE_NAME="ami-validation-test-$(date +%Y%m%d-%H%M%S)"
          INSTANCE_TYPE="${{ steps.config-validation.outputs.validation_instance_type || 't3.micro' }}"
          VPC_ID="${{ steps.config-validation.outputs.validation_vpc_id }}"
          SUBNET_ID="${{ steps.config-validation.outputs.validation_subnet_id }}"
          IAM_INSTANCE_PROFILE="${{ steps.config-validation.outputs.validation_iam_instance_profile }}"
          SECURITY_GROUP_IDS="${{ steps.config-validation.outputs.validation_security_group_ids }}"
          
          # Collect all security group IDs
          SG_IDS_LIST="$SG_ID"
          if [ -n "$SECURITY_GROUP_IDS" ] && [ "$SECURITY_GROUP_IDS" != "" ]; then
            ADDITIONAL_SGS=$(echo "$SECURITY_GROUP_IDS" | tr ',' ' ')
            SG_IDS_LIST="$SG_ID $ADDITIONAL_SGS"
          fi
          
          # Build run-instances command array
          RUN_INSTANCES_ARGS=(
            "run-instances"
            "--image-id" "$AMI_ID"
            "--instance-type" "$INSTANCE_TYPE"
            "--security-group-ids"
          )
          # Add all security group IDs as separate arguments
          for sg_id in $SG_IDS_LIST; do
            RUN_INSTANCES_ARGS+=("$sg_id")
          done
          
          # Add subnet if provided
          if [ -n "$SUBNET_ID" ] && [ "$SUBNET_ID" != "" ]; then
            RUN_INSTANCES_ARGS+=("--subnet-id" "$SUBNET_ID")
          fi
          
          # Add IAM instance profile (required for SSM)
          if [ -n "$IAM_INSTANCE_PROFILE" ] && [ "$IAM_INSTANCE_PROFILE" != "" ]; then
            RUN_INSTANCES_ARGS+=("--iam-instance-profile" "Name=$IAM_INSTANCE_PROFILE")
          else
            echo "⚠️  WARNING: IAM instance profile not set. SSM Session Manager may not work."
          fi
          
          # Add tags
          RUN_INSTANCES_ARGS+=(
            "--tag-specifications" "ResourceType=instance,Tags=[{Key=Name,Value=$INSTANCE_NAME},{Key=Purpose,Value=AMI-Validation-Test},{Key=Build,Value=${{ github.run_id }}]"
            "--region" "${{ env.PKR_VAR_aws_region }}"
            "--query" "Instances[0].InstanceId"
            "--output" "text"
          )
          
          INSTANCE_ID=$(aws ec2 "${RUN_INSTANCES_ARGS[@]}")
          
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "Test instance launched: $INSTANCE_ID"
          
          # Wait for instance to be running
          aws ec2 wait instance-running \
            --instance-ids "$INSTANCE_ID" \
            --region ${{ env.PKR_VAR_aws_region }}

      - name: Wait for SSM agent to be ready
        id: wait-ssm
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          AWS_DEFAULT_REGION: ${{ env.PKR_VAR_aws_region }}
        run: |
          INSTANCE_ID="${{ steps.launch-instance.outputs.instance_id }}"
          echo "Waiting for SSM agent to be ready on $INSTANCE_ID..."
          
          RETRY=0
          MAX_RETRIES=30
          while [ $RETRY -lt $MAX_RETRIES ]; do
            if aws ssm describe-instance-information \
              --filters "Key=InstanceIds,Values=$INSTANCE_ID" \
              --region ${{ env.PKR_VAR_aws_region }} \
              --query 'InstanceInformationList[0].PingStatus' \
              --output text 2>/dev/null | grep -q "Online"; then
              echo "SSM agent is ready!"
              exit 0
            fi
            RETRY=$((RETRY + 1))
            echo "Waiting for SSM agent... ($RETRY/$MAX_RETRIES)"
            sleep 10
          done
          
          echo "ERROR: SSM agent not ready after $MAX_RETRIES attempts"
          aws ec2 describe-instances \
            --instance-ids "$INSTANCE_ID" \
            --region ${{ env.PKR_VAR_aws_region }} \
            --query 'Reservations[0].Instances[0].[State.Name,IamInstanceProfile.Arn]' \
            --output text
          exit 1

      - name: Run AMI validation tests
        id: validate
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          AWS_DEFAULT_REGION: ${{ env.PKR_VAR_aws_region }}
        run: |
          INSTANCE_ID="${{ steps.launch-instance.outputs.instance_id }}"
          
          VALIDATION_CIS_LEVEL="${{ steps.config-validation.outputs.validation_cis_level || '2' }}"
          VALIDATION_CIS_THRESHOLD="${{ steps.config-validation.outputs.validation_cis_threshold || '80' }}"
          VALIDATION_FAIL_ON_FAILURE="${{ steps.config-validation.outputs.validation_fail_on_failure || 'false' }}"
          
          # Create Ansible inventory file for SSM
          # Use full collection path for SSM connection plugin
          cat > /tmp/validation-inventory.ini << EOF
          [validation]
          $INSTANCE_ID ansible_connection=community.aws.aws_ssm ansible_user=ec2-user ansible_host=$INSTANCE_ID
          EOF
          
          # Create ansible.cfg to configure SSM connection
          cat > ansible.cfg << EOF
          [defaults]
          host_key_checking = False
          inventory = /tmp/validation-inventory.ini
          deprecation_warnings = False
          [inventory]
          enable_plugins = host_list, ini
          [connection]
          pipelining = False
          [ssh_connection]
          pipelining = False
          EOF
          
          # Set environment variables for AWS credentials
          export AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID"
          export AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY"
          export AWS_SESSION_TOKEN="$AWS_SESSION_TOKEN"
          export AWS_DEFAULT_REGION="${{ env.PKR_VAR_aws_region }}"
          
          # Run validation playbook using SSM
          ansible-playbook \
            -i /tmp/validation-inventory.ini \
            ansible/ami-validation-playbook.yml \
            -e "cis_level=$VALIDATION_CIS_LEVEL" \
            -e "cis_compliance_threshold=$VALIDATION_CIS_THRESHOLD" \
            -e "fail_on_validation_failure=$VALIDATION_FAIL_ON_FAILURE" \
            -v 2>&1 | tee validation-output.log
          
          VALIDATION_EXIT=$?
          echo "validation_exit_code=$VALIDATION_EXIT" >> $GITHUB_OUTPUT

      - name: Display validation log
        if: always()
        run: |
          echo "## Validation Log" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat validation-output.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Cleanup - Terminate test instance
        if: always()
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          AWS_DEFAULT_REGION: ${{ env.PKR_VAR_aws_region }}
        run: |
          INSTANCE_ID="${{ steps.launch-instance.outputs.instance_id }}"
          SG_ID="${{ steps.create-sg.outputs.sg_id }}"
          
          if [ -n "$INSTANCE_ID" ] && [ "$INSTANCE_ID" != "" ]; then
            echo "Terminating test instance: $INSTANCE_ID"
            aws ec2 terminate-instances \
              --instance-ids "$INSTANCE_ID" \
              --region ${{ env.PKR_VAR_aws_region }} || true
            
            aws ec2 wait instance-terminated \
              --instance-ids "$INSTANCE_ID" \
              --region ${{ env.PKR_VAR_aws_region }} || true
          fi
          
          if [ -n "$SG_ID" ] && [ "$SG_ID" != "" ]; then
            echo "Deleting security group: $SG_ID"
            sleep 5
            aws ec2 delete-security-group \
              --group-id "$SG_ID" \
              --region ${{ env.PKR_VAR_aws_region }} || true
          fi

