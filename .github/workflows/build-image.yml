name: Build Amazon Linux 2023 Golden Image

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: 'AWS region'
        required: false
        default: 'us-east-1'
        type: string
      iam_instance_profile:
        description: 'IAM instance profile name for SSM (optional - Packer can create temporary one)'
        required: false
        default: ''
        type: string
  push:
    branches:
      - main
    paths:
      - '*.pkr.hcl'
      - '.github/workflows/**'
  pull_request:
    branches:
      - main

env:
  PKR_VAR_aws_region: ${{ github.event.inputs.aws_region || 'us-east-1' }}
  PKR_VAR_iam_instance_profile: ${{ vars.IAM_INSTANCE_PROFILE || github.event.inputs.iam_instance_profile || '' }}
  PKR_VAR_vpc_id: ${{ vars.VPC_ID || '' }}
  PKR_VAR_subnet_id: ${{ vars.SUBNET_ID || '' }}

jobs:
  validate:
    name: Validate Packer Template
    runs-on: terraform
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Inspect Runner Environment
        run: |
          echo "=== Runner OS Information ==="
          uname -a
          cat /etc/os-release
          echo ""
          echo "=== Package Manager ==="
          which dnf && dnf --version || echo "dnf not found"
          which yum && yum --version || echo "yum not found"
          echo ""
          echo "=== Pre-installed Tools ==="
          echo "cpio: $(which cpio || echo 'not found') - REQUIRED for Session Manager Plugin"
          echo "curl: $(which curl || echo 'not found')"
          echo "wget: $(which wget || echo 'not found')"
          echo "unzip: $(which unzip || echo 'not found')"
          echo "jq: $(which jq || echo 'not found')"

      - name: Install dependencies
        run: |
          # CRITICAL: Install cpio for Session Manager Plugin RPM extraction
          echo "=== Installing required packages including cpio ==="
          dnf install -y jq unzip curl cpio rpm-build tar gzip 2>&1 || {
            echo "dnf install encountered issues, installing individually..."
            for pkg in jq unzip curl cpio rpm-build tar gzip; do
              dnf install -y $pkg 2>&1 || echo "Warning: Failed to install $pkg"
            done
            # Install jq manually if needed
            if ! command -v jq >/dev/null 2>&1; then
              curl -L https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64 -o /tmp/jq
              chmod +x /tmp/jq
              mv /tmp/jq /usr/local/bin/jq || mv /tmp/jq ~/bin/jq || cp /tmp/jq ./jq
            fi
          }
          
          echo ""
          echo "=== Verification ==="
          command -v cpio && echo "✅ cpio: $(cpio --version | head -1)" || { echo "❌ cpio: MISSING - Session Manager Plugin will FAIL"; exit 1; }
          command -v jq && echo "✅ jq: $(jq --version)" || echo "⚠️ jq: not available"
          command -v unzip && echo "✅ unzip: available" || echo "⚠️ unzip: not available"

      - name: Setup Packer
        run: |
          PACKER_VERSION="1.10.0"
          curl -fsSL https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip -o packer.zip
          unzip -q packer.zip
          mv packer /usr/local/bin/
          rm packer.zip
          packer version

      - name: Clear AWS credential caches
        run: |
          echo "=== Clearing AWS credential caches ==="
          rm -rf ~/.aws/cli/cache ~/.aws/sso/cache ~/.aws/credentials ~/.aws/config 2>/dev/null || true
          unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_SECURITY_TOKEN AWS_DEFAULT_REGION AWS_REGION || true
          echo "✅ Caches cleared"

      - name: Configure AWS Credentials
        run: |
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "ERROR: AWS_ACCESS_KEY_ID secret is not configured"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "ERROR: AWS_SECRET_ACCESS_KEY secret is not configured"
            exit 1
          fi
          ACCESS_KEY=$(echo "${{ secrets.AWS_ACCESS_KEY_ID }}" | xargs)
          SECRET_KEY=$(echo "${{ secrets.AWS_SECRET_ACCESS_KEY }}" | xargs)
          SESSION_TOKEN=$(echo "${{ secrets.AWS_SESSION_TOKEN }}" | xargs)
          echo "AWS_ACCESS_KEY_ID=${ACCESS_KEY}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${SECRET_KEY}" >> $GITHUB_ENV
          if [ -n "${{ secrets.AWS_SESSION_TOKEN }}" ] && [ -n "${SESSION_TOKEN}" ]; then
            echo "AWS_SESSION_TOKEN=${SESSION_TOKEN}" >> $GITHUB_ENV
            echo "✅ AWS SSO/temporary credentials detected"
          fi
          echo "AWS_DEFAULT_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV
          echo "AWS_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV
          echo "✅ AWS credentials configured"

      - name: Verify credentials
        run: |
          echo "=== Verifying credentials ==="
          [ -n "$AWS_ACCESS_KEY_ID" ] && echo "✅ AWS_ACCESS_KEY_ID is set" || echo "❌ AWS_ACCESS_KEY_ID is NOT set"
          [ -n "$AWS_SECRET_ACCESS_KEY" ] && echo "✅ AWS_SECRET_ACCESS_KEY is set" || echo "❌ AWS_SECRET_ACCESS_KEY is NOT set"
          [ -n "$AWS_SESSION_TOKEN" ] && echo "✅ AWS_SESSION_TOKEN is set" || echo "ℹ️  No session token (long-term creds)"

      - name: Initialize Packer
        run: packer init aws-golden-image.pkr.hcl

      - name: Validate Packer template
        run: packer validate aws-golden-image.pkr.hcl

  build:
    name: Build AMI
    needs: validate
    runs-on: terraform
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          # CRITICAL: Install cpio for Session Manager Plugin RPM extraction
          echo "=== Installing required packages including cpio ==="
          dnf install -y jq unzip curl cpio rpm-build tar gzip 2>&1 || {
            echo "dnf install encountered issues, installing individually..."
            for pkg in jq unzip curl cpio rpm-build tar gzip; do
              dnf install -y $pkg 2>&1 || echo "Warning: Failed to install $pkg"
            done
            # Install jq manually if needed
            if ! command -v jq >/dev/null 2>&1; then
              curl -L https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64 -o /tmp/jq
              chmod +x /tmp/jq
              mv /tmp/jq /usr/local/bin/jq || mv /tmp/jq ~/bin/jq || cp /tmp/jq ./jq
            fi
          }
          
          echo ""
          echo "=== Verification ==="
          command -v cpio && echo "✅ cpio: $(cpio --version | head -1)" || { echo "❌ cpio: MISSING - Session Manager Plugin will FAIL"; exit 1; }
          command -v jq && echo "✅ jq: $(jq --version)" || echo "⚠️ jq: not available"
          command -v unzip && echo "✅ unzip: available" || echo "⚠️ unzip: not available"

      - name: Setup Packer
        run: |
          PACKER_VERSION="1.10.0"
          curl -fsSL https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip -o packer.zip
          unzip -q packer.zip
          mv packer /usr/local/bin/
          rm packer.zip
          packer version

      - name: Clear AWS credential caches
        run: |
          echo "=== Clearing AWS credential caches ==="
          rm -rf ~/.aws/cli/cache ~/.aws/sso/cache ~/.aws/credentials ~/.aws/config 2>/dev/null || true
          unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_SECURITY_TOKEN AWS_DEFAULT_REGION AWS_REGION || true
          echo "✅ Caches cleared"

      - name: Configure AWS Credentials
        run: |
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "ERROR: AWS_ACCESS_KEY_ID secret is not configured"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "ERROR: AWS_SECRET_ACCESS_KEY secret is not configured"
            exit 1
          fi
          ACCESS_KEY=$(echo "${{ secrets.AWS_ACCESS_KEY_ID }}" | xargs)
          SECRET_KEY=$(echo "${{ secrets.AWS_SECRET_ACCESS_KEY }}" | xargs)
          SESSION_TOKEN=$(echo "${{ secrets.AWS_SESSION_TOKEN }}" | xargs)
          echo "AWS_ACCESS_KEY_ID=${ACCESS_KEY}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${SECRET_KEY}" >> $GITHUB_ENV
          if [ -n "${{ secrets.AWS_SESSION_TOKEN }}" ] && [ -n "${SESSION_TOKEN}" ]; then
            echo "AWS_SESSION_TOKEN=${SESSION_TOKEN}" >> $GITHUB_ENV
            echo "✅ AWS SSO/temporary credentials detected"
          fi
          echo "AWS_DEFAULT_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV
          echo "AWS_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV
          echo "✅ AWS credentials configured"

      - name: Verify credentials
        run: |
          echo "=== Verifying credentials ==="
          [ -n "$AWS_ACCESS_KEY_ID" ] && echo "✅ AWS_ACCESS_KEY_ID is set" || echo "❌ AWS_ACCESS_KEY_ID is NOT set"
          [ -n "$AWS_SECRET_ACCESS_KEY" ] && echo "✅ AWS_SECRET_ACCESS_KEY is set" || echo "❌ AWS_SECRET_ACCESS_KEY is NOT set"
          [ -n "$AWS_SESSION_TOKEN" ] && echo "✅ AWS_SESSION_TOKEN is set" || echo "ℹ️  No session token (long-term creds)"

      - name: Install AWS Session Manager Plugin
        run: |
          echo "=== Installing AWS Session Manager Plugin ==="
          if command -v session-manager-plugin >/dev/null 2>&1; then
            echo "✅ Session Manager Plugin is already installed:"
            session-manager-plugin --version
            exit 0
          fi
          
          echo "Installing Session Manager Plugin..."
          LOCAL_RPM="rpm/session-manager-plugin.rpm"
          RPM_FILE="/tmp/session-manager-plugin.rpm"
          
          # Use local RPM if available, otherwise download
          if [ -f "$LOCAL_RPM" ]; then
            echo "✅ Found local RPM file: $LOCAL_RPM"
            cp "$LOCAL_RPM" "$RPM_FILE"
          else
            echo "Downloading from AWS..."
            PLUGIN_URL="https://s3.amazonaws.com/session-manager-downloads/plugin/latest/linux_64bit/session-manager-plugin.rpm"
            curl -fsSL "$PLUGIN_URL" -o "$RPM_FILE" || {
              echo "❌ Failed to download Session Manager Plugin"
              exit 1
            }
          fi
          
          # Verify cpio is available (CRITICAL)
          if ! command -v cpio >/dev/null 2>&1; then
            echo "❌ CRITICAL: cpio is not installed"
            echo "Cannot extract RPM without cpio"
            echo "Run: dnf install -y cpio"
            exit 1
          fi
          
          # Extract RPM using rpm2cpio + cpio (the standard method)
          echo "Extracting RPM package..."
          EXTRACT_DIR=$(mktemp -d)
          cd "$EXTRACT_DIR"
          
          if rpm2cpio "$RPM_FILE" | cpio -idmv 2>&1 | grep -q "blocks"; then
            echo "✅ Extraction successful"
          else
            echo "❌ Extraction failed"
            exit 1
          fi
          
          # Find and install the binary
          BINARY_PATH=$(find "$EXTRACT_DIR" -name "session-manager-plugin" -type f | head -1)
          if [ -z "$BINARY_PATH" ]; then
            echo "❌ Binary not found after extraction"
            exit 1
          fi
          
          echo "Found binary at: $BINARY_PATH"
          mkdir -p ~/bin
          cp "$BINARY_PATH" ~/bin/
          chmod +x ~/bin/session-manager-plugin
          echo "$HOME/bin" >> $GITHUB_PATH
          
          # Verify installation
          ~/bin/session-manager-plugin --version
          echo "✅ Session Manager Plugin installed successfully"
          
          # Cleanup
          rm -rf "$EXTRACT_DIR" "$RPM_FILE"

      - name: Initialize Packer
        run: packer init aws-golden-image.pkr.hcl

      - name: Build Packer image
        run: |
          PACKER_BUILD_CMD="packer build -var=\"aws_region=${{ env.PKR_VAR_aws_region }}\""
          
          if [ -n "${{ env.PKR_VAR_iam_instance_profile }}" ]; then
            PACKER_BUILD_CMD="${PACKER_BUILD_CMD} -var=\"iam_instance_profile=${{ env.PKR_VAR_iam_instance_profile }}\""
          fi
          
          if [ -n "${{ env.PKR_VAR_vpc_id }}" ]; then
            PACKER_BUILD_CMD="${PACKER_BUILD_CMD} -var=\"vpc_id=${{ env.PKR_VAR_vpc_id }}\""
          fi
          
          if [ -n "${{ env.PKR_VAR_subnet_id }}" ]; then
            PACKER_BUILD_CMD="${PACKER_BUILD_CMD} -var=\"subnet_id=${{ env.PKR_VAR_subnet_id }}\""
          fi
          
          SECURITY_GROUP_IDS="${{ vars.SECURITY_GROUP_IDS }}"
          if [ -n "$SECURITY_GROUP_IDS" ]; then
            SG_HCL=$(echo "$SECURITY_GROUP_IDS" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed 's/^/"/;s/$/"/' | tr '\n' ',' | sed 's/,$//' | sed 's/^/[/;s/$/]/')
            VAR_FILE=$(mktemp --suffix=.hcl)
            echo "security_group_ids = $SG_HCL" > "$VAR_FILE"
            PACKER_BUILD_CMD="${PACKER_BUILD_CMD} -var-file=$VAR_FILE"
          fi
          
          PACKER_BUILD_CMD="${PACKER_BUILD_CMD} aws-golden-image.pkr.hcl"
          eval $PACKER_BUILD_CMD

      - name: Output AMI ID
        if: success()
        run: |
          echo "✅ AMI build completed successfully!"
          echo "Check AWS EC2 Console for the latest AMI"