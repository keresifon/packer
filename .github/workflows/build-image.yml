name: Build Amazon Linux 2023 Golden Image

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: 'AWS region'
        required: false
        default: 'us-east-1'
        type: string
      iam_instance_profile:
        description: 'IAM instance profile name for SSM (optional - Packer can create temporary one)'
        required: false
        default: ''
        type: string
  push:
    branches:
      - main
    paths:
      - '*.pkr.hcl'
      - '.github/workflows/**'
  pull_request:
    branches:
      - main

env:
  PKR_VAR_aws_region: ${{ github.event.inputs.aws_region || 'us-east-1' }}
  PKR_VAR_iam_instance_profile: ${{ vars.IAM_INSTANCE_PROFILE || github.event.inputs.iam_instance_profile || '' }}
  PKR_VAR_vpc_id: ${{ vars.VPC_ID || '' }}
  PKR_VAR_subnet_id: ${{ vars.SUBNET_ID || '' }}

jobs:
  validate:
    name: Validate Packer Template
    runs-on: terraform
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup user bin directory
        run: |
          mkdir -p ~/bin ~/.local/bin
          echo "$HOME/bin" >> $GITHUB_PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          export PATH="$HOME/bin:$HOME/.local/bin:$PATH"

      - name: Install cpio from local RPM (CRITICAL)
        run: |
          echo "=== Installing cpio from local RPM file ==="
          
          # Check if cpio is already available
          if command -v cpio >/dev/null 2>&1; then
            echo "✅ cpio is already available: $(cpio --version | head -1)"
            exit 0
          fi
          
          # Look for cpio RPM in rpm directory
          CPIO_RPM="rpm/cpio-*.rpm"
          
          if ! ls $CPIO_RPM 1> /dev/null 2>&1; then
            echo "❌ ERROR: cpio RPM not found in rpm/ directory"
            echo ""
            echo "Please download cpio RPM and add it to your repository:"
            echo ""
            echo "On a RHEL 9.6 machine with internet access, run:"
            echo "  mkdir -p rpm"
            echo "  dnf download cpio --downloaddir=rpm/"
            echo "  git add rpm/cpio-*.rpm"
            echo "  git commit -m 'Add cpio RPM for offline installation'"
            echo "  git push"
            echo ""
            echo "Alternative: Download from RHEL mirror:"
            echo "  https://vault.centos.org/9-stream/BaseOS/x86_64/os/Packages/"
            echo "  Look for: cpio-2.13-*.el9.x86_64.rpm"
            exit 1
          fi
          
          # Find the actual RPM file
          CPIO_RPM_FILE=$(ls rpm/cpio-*.rpm 2>/dev/null | head -1)
          echo "Found cpio RPM: $CPIO_RPM_FILE"
          
          # Extract RPM without rpm2cpio (bootstrap method using Python)
          echo "Extracting cpio RPM using Python..."
          EXTRACT_DIR=$(mktemp -d)
          
          # Python script to extract RPM (AR archive format)
          python3 << 'PYTHON_EOF'
import sys
import os
import gzip
import tarfile
import io

rpm_file = sys.argv[1]
extract_dir = sys.argv[2]

try:
    with open(rpm_file, 'rb') as f:
        # Read AR archive header
        if f.read(8) != b'!<arch>\n':
            print("Not an AR archive")
            sys.exit(1)
        
        while True:
            # Read AR member header (60 bytes)
            header = f.read(60)
            if len(header) < 60:
                break
            
            # Skip padding
            if header[:2] == b'`\n':
                continue
            
            # Parse filename and size
            name = header[:16].strip().decode('ascii', errors='ignore').rstrip('/')
            size = int(header[48:58].strip().decode('ascii', errors='ignore'))
            
            # Look for data.tar.gz or similar
            if name.startswith('data.tar'):
                print(f"Found: {name} (size: {size})")
                data = f.read(size)
                
                # Try different decompression methods
                for decompress in [gzip.decompress, lambda x: x]:
                    try:
                        decompressed = decompress(data)
                        tar = tarfile.open(fileobj=io.BytesIO(decompressed))
                        tar.extractall(extract_dir)
                        print(f"Extracted {len(tar.getmembers())} files")
                        sys.exit(0)
                    except:
                        continue
            else:
                # Skip to next member (aligned to 2 bytes)
                if size % 2:
                    size += 1
                f.seek(size, 1)
    
    sys.exit(1)
except Exception as e:
    print(f"Error: {e}")
    sys.exit(1)
PYTHON_EOF
          
          if python3 - "$CPIO_RPM_FILE" "$EXTRACT_DIR" << 'PYTHON_EOF'
import sys
import os
import gzip
import tarfile
import io

rpm_file = sys.argv[1]
extract_dir = sys.argv[2]

try:
    with open(rpm_file, 'rb') as f:
        # Read AR archive header
        if f.read(8) != b'!<arch>\n':
            print("Not an AR archive, trying as RPM...")
            # Reset and try as RPM
            f.seek(0)
            # Skip RPM lead (96 bytes) and signature
            f.seek(96)
            # This is complex, just fail for now
            sys.exit(1)
        
        while True:
            # Read AR member header (60 bytes)
            header = f.read(60)
            if len(header) < 60:
                break
            
            # Skip padding
            if header[:2] == b'`\n':
                continue
            
            # Parse filename and size
            name = header[:16].strip().decode('ascii', errors='ignore').rstrip('/')
            try:
                size = int(header[48:58].strip().decode('ascii', errors='ignore'))
            except:
                break
            
            # Look for data.tar.gz or similar
            if name.startswith('data.tar'):
                print(f"Found: {name} (size: {size})")
                data = f.read(size)
                
                # Try different decompression methods
                for decompress in [gzip.decompress, lambda x: x]:
                    try:
                        decompressed = decompress(data)
                        tar = tarfile.open(fileobj=io.BytesIO(decompressed))
                        tar.extractall(extract_dir)
                        print(f"Extracted {len(tar.getmembers())} files")
                        sys.exit(0)
                    except:
                        continue
            else:
                # Skip to next member (aligned to 2 bytes)
                if size % 2:
                    size += 1
                f.seek(size, 1)
    
    sys.exit(1)
except Exception as e:
    print(f"Error: {e}")
    import traceback
    traceback.print_exc()
    sys.exit(1)
PYTHON_EOF
          then
            echo "✅ RPM extracted successfully"
          else
            echo "⚠️  Python extraction failed, trying alternative method..."
            
            # Alternative: Use ar and tar if available
            if command -v ar >/dev/null 2>&1 && command -v tar >/dev/null 2>&1; then
              cd "$EXTRACT_DIR"
              ar x "$OLDPWD/$CPIO_RPM_FILE" 2>/dev/null || true
              for tarfile in data.tar.* data.tar; do
                if [ -f "$tarfile" ]; then
                  tar -xf "$tarfile" 2>/dev/null && break
                fi
              done
              cd -
            else
              echo "❌ Cannot extract RPM without ar/tar or working Python"
              exit 1
            fi
          fi
          
          # Find cpio binary in extracted files
          CPIO_BINARY=$(find "$EXTRACT_DIR" -name "cpio" -type f -executable | head -1)
          
          if [ -z "$CPIO_BINARY" ]; then
            echo "❌ cpio binary not found in extracted RPM"
            echo "Extracted files:"
            find "$EXTRACT_DIR" -type f | head -20
            exit 1
          fi
          
          echo "Found cpio binary: $CPIO_BINARY"
          
          # Copy to ~/bin
          cp "$CPIO_BINARY" ~/bin/cpio
          chmod +x ~/bin/cpio
          
          # Verify installation
          if ~/bin/cpio --version; then
            echo "✅ cpio installed successfully to ~/bin"
          else
            echo "❌ cpio installation verification failed"
            exit 1
          fi
          
          # Cleanup
          rm -rf "$EXTRACT_DIR"

      - name: Install other dependencies to user directory
        run: |
          echo "=== Installing other dependencies ==="
          
          # Install jq if not available
          if ! command -v jq >/dev/null 2>&1; then
            # Check for local jq binary first
            if [ -f "bin/jq" ]; then
              echo "Installing jq from local file..."
              cp bin/jq ~/bin/jq
              chmod +x ~/bin/jq
            else
              echo "⚠️  jq not found locally, workflow may fail if needed"
            fi
          fi
          
          # Verify critical tools
          echo ""
          echo "=== Verification ==="
          command -v cpio && echo "✅ cpio: $(cpio --version | head -1)" || { echo "❌ cpio: MISSING"; exit 1; }
          command -v jq && echo "✅ jq: $(jq --version)" || echo "⚠️  jq: not available"
          command -v curl && echo "✅ curl: available" || echo "❌ curl: MISSING"
          command -v unzip && echo "✅ unzip: available" || echo "❌ unzip: MISSING"
          command -v tar && echo "✅ tar: available" || echo "❌ tar: MISSING"
          command -v rpm2cpio && echo "✅ rpm2cpio: available" || echo "⚠️  rpm2cpio: not available"

      - name: Setup Packer
        run: |
          PACKER_VERSION="1.10.0"
          
          # Check if Packer is already installed
          if command -v packer >/dev/null 2>&1; then
            INSTALLED_VERSION=$(packer version | head -1 | awk '{print $2}' | sed 's/v//')
            if [ "$INSTALLED_VERSION" == "$PACKER_VERSION" ]; then
              echo "✅ Packer ${PACKER_VERSION} is already installed"
              packer version
              exit 0
            fi
          fi
          
          echo "Installing Packer ${PACKER_VERSION} from local file or download..."
          
          # Check for local Packer zip
          if [ -f "bin/packer_${PACKER_VERSION}_linux_amd64.zip" ]; then
            echo "Using local Packer zip..."
            unzip -q "bin/packer_${PACKER_VERSION}_linux_amd64.zip" -d ~/bin/
          else
            echo "Downloading Packer (if this fails, include zip in repo)..."
            curl -fsSL "https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip" -o /tmp/packer.zip
            unzip -q /tmp/packer.zip -d ~/bin/
            rm /tmp/packer.zip
          fi
          
          chmod +x ~/bin/packer
          packer version

      - name: Clear AWS credential caches
        run: |
          echo "=== Clearing AWS credential caches ==="
          rm -rf ~/.aws/cli/cache ~/.aws/sso/cache ~/.aws/credentials ~/.aws/config 2>/dev/null || true
          unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_SECURITY_TOKEN AWS_DEFAULT_REGION AWS_REGION || true
          echo "✅ Caches cleared"

      - name: Configure AWS Credentials
        run: |
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "ERROR: AWS_ACCESS_KEY_ID secret is not configured"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "ERROR: AWS_SECRET_ACCESS_KEY secret is not configured"
            exit 1
          fi
          ACCESS_KEY=$(echo "${{ secrets.AWS_ACCESS_KEY_ID }}" | xargs)
          SECRET_KEY=$(echo "${{ secrets.AWS_SECRET_ACCESS_KEY }}" | xargs)
          SESSION_TOKEN=$(echo "${{ secrets.AWS_SESSION_TOKEN }}" | xargs)
          echo "AWS_ACCESS_KEY_ID=${ACCESS_KEY}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${SECRET_KEY}" >> $GITHUB_ENV
          if [ -n "${{ secrets.AWS_SESSION_TOKEN }}" ] && [ -n "${SESSION_TOKEN}" ]; then
            echo "AWS_SESSION_TOKEN=${SESSION_TOKEN}" >> $GITHUB_ENV
            echo "✅ AWS SSO/temporary credentials detected"
          fi
          echo "AWS_DEFAULT_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV
          echo "AWS_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV
          echo "✅ AWS credentials configured"

      - name: Initialize Packer
        run: packer init aws-golden-image.pkr.hcl

      - name: Validate Packer template
        run: packer validate aws-golden-image.pkr.hcl

  build:
    name: Build AMI
    needs: validate
    runs-on: terraform
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup user bin directory
        run: |
          mkdir -p ~/bin ~/.local/bin
          echo "$HOME/bin" >> $GITHUB_PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          export PATH="$HOME/bin:$HOME/.local/bin:$PATH"

      - name: Install cpio from local RPM (CRITICAL)
        run: |
          echo "=== Installing cpio from local RPM file ==="
          
          # Check if cpio is already available
          if command -v cpio >/dev/null 2>&1; then
            echo "✅ cpio is already available: $(cpio --version | head -1)"
            exit 0
          fi
          
          # Look for cpio RPM in rpm directory
          CPIO_RPM="rpm/cpio-*.rpm"
          
          if ! ls $CPIO_RPM 1> /dev/null 2>&1; then
            echo "❌ ERROR: cpio RPM not found in rpm/ directory"
            echo ""
            echo "Please download cpio RPM and add it to your repository:"
            echo ""
            echo "On a RHEL 9.6 machine with internet access, run:"
            echo "  mkdir -p rpm"
            echo "  dnf download cpio --downloaddir=rpm/"
            echo "  git add rpm/cpio-*.rpm"
            echo "  git commit -m 'Add cpio RPM for offline installation'"
            echo "  git push"
            echo ""
            echo "Alternative: Download from RHEL mirror:"
            echo "  https://vault.centos.org/9-stream/BaseOS/x86_64/os/Packages/"
            echo "  Look for: cpio-2.13-*.el9.x86_64.rpm"
            exit 1
          fi
          
          # Find the actual RPM file
          CPIO_RPM_FILE=$(ls rpm/cpio-*.rpm 2>/dev/null | head -1)
          echo "Found cpio RPM: $CPIO_RPM_FILE"
          
          # Extract using Python
          echo "Extracting cpio RPM..."
          EXTRACT_DIR=$(mktemp -d)
          
          python3 << PYTHON_EOF "$CPIO_RPM_FILE" "$EXTRACT_DIR"
import sys
import os
import gzip
import tarfile
import io

rpm_file = sys.argv[1]
extract_dir = sys.argv[2]

try:
    with open(rpm_file, 'rb') as f:
        # Read AR archive header
        if f.read(8) != b'!<arch>\\n':
            print("Not an AR archive format")
            sys.exit(1)
        
        while True:
            header = f.read(60)
            if len(header) < 60:
                break
            
            if header[:2] == b'\`\\n':
                continue
            
            name = header[:16].strip().decode('ascii', errors='ignore').rstrip('/')
            try:
                size = int(header[48:58].strip().decode('ascii', errors='ignore'))
            except:
                break
            
            if name.startswith('data.tar'):
                print(f"Extracting {name}...")
                data = f.read(size)
                
                for decompress in [gzip.decompress, lambda x: x]:
                    try:
                        decompressed = decompress(data)
                        tar = tarfile.open(fileobj=io.BytesIO(decompressed))
                        tar.extractall(extract_dir)
                        print(f"✅ Extracted {len(tar.getmembers())} files")
                        sys.exit(0)
                    except:
                        continue
            else:
                if size % 2:
                    size += 1
                f.seek(size, 1)
    
    print("❌ data.tar not found in RPM")
    sys.exit(1)
except Exception as e:
    print(f"❌ Error: {e}")
    import traceback
    traceback.print_exc()
    sys.exit(1)
PYTHON_EOF
          
          if [ $? -ne 0 ]; then
            echo "❌ Failed to extract RPM"
            exit 1
          fi
          
          # Find and install cpio binary
          CPIO_BINARY=$(find "$EXTRACT_DIR" -path "*/bin/cpio" -type f | head -1)
          
          if [ -z "$CPIO_BINARY" ]; then
            echo "⚠️  Looking for cpio in alternative locations..."
            CPIO_BINARY=$(find "$EXTRACT_DIR" -name "cpio" -type f -executable | head -1)
          fi
          
          if [ -z "$CPIO_BINARY" ]; then
            echo "❌ cpio binary not found"
            echo "Extracted structure:"
            find "$EXTRACT_DIR" -type f | head -30
            exit 1
          fi
          
          echo "Found: $CPIO_BINARY"
          cp "$CPIO_BINARY" ~/bin/cpio
          chmod +x ~/bin/cpio
          
          ~/bin/cpio --version
          echo "✅ cpio installed to ~/bin"
          
          rm -rf "$EXTRACT_DIR"

      - name: Install other dependencies
        run: |
          echo "=== Installing dependencies ==="
          if ! command -v jq >/dev/null 2>&1 && [ -f "bin/jq" ]; then
            cp bin/jq ~/bin/jq
            chmod +x ~/bin/jq
          fi
          
          echo "=== Verification ==="
          command -v cpio && echo "✅ cpio: $(cpio --version | head -1)" || { echo "❌ cpio: MISSING"; exit 1; }

      - name: Setup Packer
        run: |
          PACKER_VERSION="1.10.0"
          if command -v packer >/dev/null 2>&1; then
            echo "✅ Packer already installed"
            packer version
            exit 0
          fi
          
          if [ -f "bin/packer_${PACKER_VERSION}_linux_amd64.zip" ]; then
            unzip -q "bin/packer_${PACKER_VERSION}_linux_amd64.zip" -d ~/bin/
          else
            curl -fsSL "https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip" -o /tmp/packer.zip
            unzip -q /tmp/packer.zip -d ~/bin/
            rm /tmp/packer.zip
          fi
          chmod +x ~/bin/packer
          packer version

      - name: Clear AWS credential caches
        run: |
          rm -rf ~/.aws/cli/cache ~/.aws/sso/cache ~/.aws/credentials ~/.aws/config 2>/dev/null || true
          unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_SECURITY_TOKEN AWS_DEFAULT_REGION AWS_REGION || true

      - name: Configure AWS Credentials
        run: |
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ] || [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "ERROR: AWS credentials not configured"
            exit 1
          fi
          ACCESS_KEY=$(echo "${{ secrets.AWS_ACCESS_KEY_ID }}" | xargs)
          SECRET_KEY=$(echo "${{ secrets.AWS_SECRET_ACCESS_KEY }}" | xargs)
          SESSION_TOKEN=$(echo "${{ secrets.AWS_SESSION_TOKEN }}" | xargs)
          echo "AWS_ACCESS_KEY_ID=${ACCESS_KEY}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${SECRET_KEY}" >> $GITHUB_ENV
          [ -n "${SESSION_TOKEN}" ] && echo "AWS_SESSION_TOKEN=${SESSION_TOKEN}" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV
          echo "AWS_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV

      - name: Install AWS Session Manager Plugin
        run: |
          if command -v session-manager-plugin >/dev/null 2>&1; then
            echo "✅ Already installed"
            session-manager-plugin --version
            exit 0
          fi
          
          LOCAL_RPM="rpm/session-manager-plugin.rpm"
          if [ ! -f "$LOCAL_RPM" ]; then
            echo "❌ ERROR: $LOCAL_RPM not found"
            echo "Download it and add to your repo:"
            echo "  curl -o rpm/session-manager-plugin.rpm https://s3.amazonaws.com/session-manager-downloads/plugin/latest/linux_64bit/session-manager-plugin.rpm"
            echo "  git add rpm/session-manager-plugin.rpm"
            echo "  git commit -m 'Add Session Manager Plugin RPM'"
            exit 1
          fi
          
          echo "Extracting Session Manager Plugin..."
          EXTRACT_DIR=$(mktemp -d)
          cd "$EXTRACT_DIR"
          rpm2cpio "$OLDPWD/$LOCAL_RPM" | cpio -idmv 2>&1 | head -10
          
          BINARY=$(find . -name "session-manager-plugin" -type f | head -1)
          if [ -z "$BINARY" ]; then
            echo "❌ Binary not found"
            exit 1
          fi
          
          cp "$BINARY" ~/bin/session-manager-plugin
          chmod +x ~/bin/session-manager-plugin
          ~/bin/session-manager-plugin --version
          echo "✅ Installed"
          rm -rf "$EXTRACT_DIR"

      - name: Initialize Packer
        run: packer init aws-golden-image.pkr.hcl

      - name: Build Packer image
        run: |
          PACKER_BUILD_CMD="packer build -var=\"aws_region=${{ env.PKR_VAR_aws_region }}\""
          [ -n "${{ env.PKR_VAR_iam_instance_profile }}" ] && PACKER_BUILD_CMD="${PACKER_BUILD_CMD} -var=\"iam_instance_profile=${{ env.PKR_VAR_iam_instance_profile }}\""
          [ -n "${{ env.PKR_VAR_vpc_id }}" ] && PACKER_BUILD_CMD="${PACKER_BUILD_CMD} -var=\"vpc_id=${{ env.PKR_VAR_vpc_id }}\""
          [ -n "${{ env.PKR_VAR_subnet_id }}" ] && PACKER_BUILD_CMD="${PACKER_BUILD_CMD} -var=\"subnet_id=${{ env.PKR_VAR_subnet_id }}\""
          
          SECURITY_GROUP_IDS="${{ vars.SECURITY_GROUP_IDS }}"
          if [ -n "$SECURITY_GROUP_IDS" ]; then
            SG_HCL=$(echo "$SECURITY_GROUP_IDS" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed 's/^/"/;s/$/"/' | tr '\n' ',' | sed 's/,$//' | sed 's/^/[/;s/$/]/')
            VAR_FILE=$(mktemp --suffix=.hcl)
            echo "security_group_ids = $SG_HCL" > "$VAR_FILE"
            PACKER_BUILD_CMD="${PACKER_BUILD_CMD} -var-file=$VAR_FILE"
          fi
          
          PACKER_BUILD_CMD="${PACKER_BUILD_CMD} aws-golden-image.pkr.hcl"
          eval $PACKER_BUILD_CMD

      - name: Output AMI ID
        if: success()
        run: echo "✅ AMI build completed successfully!"