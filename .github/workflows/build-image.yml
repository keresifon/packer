name: Build Amazon Linux 2023 Golden Image

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: 'AWS region'
        required: false
        default: 'us-east-1'
        type: string
      iam_instance_profile:
        description: 'IAM instance profile name for SSM (optional - Packer can create temporary one)'
        required: false
        default: ''
        type: string
  push:
    branches:
      - main
    paths:
      - '*.pkr.hcl'
      - '.github/workflows/**'
  pull_request:
    branches:
      - main

env:
  PKR_VAR_aws_region: ${{ github.event.inputs.aws_region || 'us-east-1' }}
  PKR_VAR_iam_instance_profile: ${{ vars.IAM_INSTANCE_PROFILE || github.event.inputs.iam_instance_profile || '' }}
  PKR_VAR_vpc_id: ${{ vars.VPC_ID || '' }}
  PKR_VAR_subnet_id: ${{ vars.SUBNET_ID || '' }}

jobs:
  validate:
    name: Validate Packer Template
    runs-on: terraform
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup user bin directory
        run: |
          mkdir -p ~/bin ~/.local/bin
          echo "$HOME/bin" >> $GITHUB_PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          export PATH="$HOME/bin:$HOME/.local/bin:$PATH"

      - name: Install cpio to user directory (CRITICAL)
        run: |
          echo "=== Installing cpio to ~/bin (no root required) ==="
          
          # Check if cpio is already available
          if command -v cpio >/dev/null 2>&1; then
            echo "✅ cpio is already available: $(cpio --version | head -1)"
            exit 0
          fi
          
          # Download and compile cpio from source (no root needed)
          CPIO_VERSION="2.14"
          CPIO_URL="https://ftp.gnu.org/gnu/cpio/cpio-${CPIO_VERSION}.tar.gz"
          
          echo "Downloading cpio source..."
          cd /tmp
          curl -fsSL "$CPIO_URL" -o cpio.tar.gz
          tar -xzf cpio.tar.gz
          cd cpio-${CPIO_VERSION}
          
          echo "Compiling cpio (this may take a minute)..."
          ./configure --prefix="$HOME/.local" 2>&1 | tail -5
          make -j$(nproc) 2>&1 | tail -5
          make install 2>&1 | tail -5
          
          # Verify installation
          if [ -x "$HOME/.local/bin/cpio" ]; then
            echo "✅ cpio installed successfully to ~/.local/bin"
            "$HOME/.local/bin/cpio" --version | head -1
            ln -sf "$HOME/.local/bin/cpio" "$HOME/bin/cpio" 2>/dev/null || true
          else
            echo "❌ Failed to install cpio"
            exit 1
          fi
          
          # Cleanup
          cd /tmp
          rm -rf cpio-${CPIO_VERSION} cpio.tar.gz

      - name: Install other dependencies to user directory
        run: |
          echo "=== Installing dependencies to user directory ==="
          
          # Install jq if not available
          if ! command -v jq >/dev/null 2>&1; then
            echo "Installing jq..."
            curl -L https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64 -o ~/bin/jq
            chmod +x ~/bin/jq
          fi
          
          # Verify critical tools
          echo ""
          echo "=== Verification ==="
          command -v cpio && echo "✅ cpio: $(cpio --version | head -1)" || echo "❌ cpio: MISSING"
          command -v jq && echo "✅ jq: $(jq --version)" || echo "❌ jq: MISSING"
          command -v curl && echo "✅ curl: available" || echo "❌ curl: MISSING"
          command -v unzip && echo "✅ unzip: available" || echo "❌ unzip: MISSING"
          command -v tar && echo "✅ tar: available" || echo "❌ tar: MISSING"
          command -v rpm2cpio && echo "✅ rpm2cpio: available" || echo "❌ rpm2cpio: MISSING"

      - name: Setup Packer
        run: |
          PACKER_VERSION="1.10.0"
          
          # Check if Packer is already installed
          if command -v packer >/dev/null 2>&1; then
            INSTALLED_VERSION=$(packer version | head -1 | awk '{print $2}' | sed 's/v//')
            if [ "$INSTALLED_VERSION" == "$PACKER_VERSION" ]; then
              echo "✅ Packer ${PACKER_VERSION} is already installed"
              packer version
              exit 0
            fi
          fi
          
          echo "Installing Packer ${PACKER_VERSION} to ~/bin..."
          curl -fsSL https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip -o /tmp/packer.zip
          unzip -q /tmp/packer.zip -d ~/bin/
          chmod +x ~/bin/packer
          rm /tmp/packer.zip
          packer version

      - name: Clear AWS credential caches
        run: |
          echo "=== Clearing AWS credential caches ==="
          rm -rf ~/.aws/cli/cache ~/.aws/sso/cache ~/.aws/credentials ~/.aws/config 2>/dev/null || true
          unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_SECURITY_TOKEN AWS_DEFAULT_REGION AWS_REGION || true
          echo "✅ Caches cleared"

      - name: Configure AWS Credentials
        run: |
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "ERROR: AWS_ACCESS_KEY_ID secret is not configured"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "ERROR: AWS_SECRET_ACCESS_KEY secret is not configured"
            exit 1
          fi
          ACCESS_KEY=$(echo "${{ secrets.AWS_ACCESS_KEY_ID }}" | xargs)
          SECRET_KEY=$(echo "${{ secrets.AWS_SECRET_ACCESS_KEY }}" | xargs)
          SESSION_TOKEN=$(echo "${{ secrets.AWS_SESSION_TOKEN }}" | xargs)
          echo "AWS_ACCESS_KEY_ID=${ACCESS_KEY}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${SECRET_KEY}" >> $GITHUB_ENV
          if [ -n "${{ secrets.AWS_SESSION_TOKEN }}" ] && [ -n "${SESSION_TOKEN}" ]; then
            echo "AWS_SESSION_TOKEN=${SESSION_TOKEN}" >> $GITHUB_ENV
            echo "✅ AWS SSO/temporary credentials detected"
          fi
          echo "AWS_DEFAULT_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV
          echo "AWS_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV
          echo "✅ AWS credentials configured"

      - name: Initialize Packer
        run: packer init aws-golden-image.pkr.hcl

      - name: Validate Packer template
        run: packer validate aws-golden-image.pkr.hcl

  build:
    name: Build AMI
    needs: validate
    runs-on: terraform
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup user bin directory
        run: |
          mkdir -p ~/bin ~/.local/bin
          echo "$HOME/bin" >> $GITHUB_PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          export PATH="$HOME/bin:$HOME/.local/bin:$PATH"

      - name: Install cpio to user directory (CRITICAL)
        run: |
          echo "=== Installing cpio to ~/bin (no root required) ==="
          
          # Check if cpio is already available
          if command -v cpio >/dev/null 2>&1; then
            echo "✅ cpio is already available: $(cpio --version | head -1)"
            exit 0
          fi
          
          # Download and compile cpio from source (no root needed)
          CPIO_VERSION="2.14"
          CPIO_URL="https://ftp.gnu.org/gnu/cpio/cpio-${CPIO_VERSION}.tar.gz"
          
          echo "Downloading cpio source..."
          cd /tmp
          curl -fsSL "$CPIO_URL" -o cpio.tar.gz
          tar -xzf cpio.tar.gz
          cd cpio-${CPIO_VERSION}
          
          echo "Compiling cpio (this may take a minute)..."
          ./configure --prefix="$HOME/.local" 2>&1 | tail -5
          make -j$(nproc) 2>&1 | tail -5
          make install 2>&1 | tail -5
          
          # Verify installation
          if [ -x "$HOME/.local/bin/cpio" ]; then
            echo "✅ cpio installed successfully to ~/.local/bin"
            "$HOME/.local/bin/cpio" --version | head -1
            ln -sf "$HOME/.local/bin/cpio" "$HOME/bin/cpio" 2>/dev/null || true
          else
            echo "❌ Failed to install cpio"
            exit 1
          fi
          
          # Cleanup
          cd /tmp
          rm -rf cpio-${CPIO_VERSION} cpio.tar.gz

      - name: Install other dependencies to user directory
        run: |
          echo "=== Installing dependencies to user directory ==="
          
          # Install jq if not available
          if ! command -v jq >/dev/null 2>&1; then
            echo "Installing jq..."
            curl -L https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64 -o ~/bin/jq
            chmod +x ~/bin/jq
          fi
          
          # Verify critical tools
          echo ""
          echo "=== Verification ==="
          command -v cpio && echo "✅ cpio: $(cpio --version | head -1)" || echo "❌ cpio: MISSING"
          command -v jq && echo "✅ jq: $(jq --version)" || echo "❌ jq: MISSING"
          command -v curl && echo "✅ curl: available" || echo "❌ curl: MISSING"
          command -v unzip && echo "✅ unzip: available" || echo "❌ unzip: MISSING"
          command -v tar && echo "✅ tar: available" || echo "❌ tar: MISSING"
          command -v rpm2cpio && echo "✅ rpm2cpio: available" || echo "❌ rpm2cpio: MISSING"

      - name: Setup Packer
        run: |
          PACKER_VERSION="1.10.0"
          
          # Check if Packer is already installed
          if command -v packer >/dev/null 2>&1; then
            INSTALLED_VERSION=$(packer version | head -1 | awk '{print $2}' | sed 's/v//')
            if [ "$INSTALLED_VERSION" == "$PACKER_VERSION" ]; then
              echo "✅ Packer ${PACKER_VERSION} is already installed"
              packer version
              exit 0
            fi
          fi
          
          echo "Installing Packer ${PACKER_VERSION} to ~/bin..."
          curl -fsSL https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip -o /tmp/packer.zip
          unzip -q /tmp/packer.zip -d ~/bin/
          chmod +x ~/bin/packer
          rm /tmp/packer.zip
          packer version

      - name: Clear AWS credential caches
        run: |
          echo "=== Clearing AWS credential caches ==="
          rm -rf ~/.aws/cli/cache ~/.aws/sso/cache ~/.aws/credentials ~/.aws/config 2>/dev/null || true
          unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_SECURITY_TOKEN AWS_DEFAULT_REGION AWS_REGION || true
          echo "✅ Caches cleared"

      - name: Configure AWS Credentials
        run: |
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "ERROR: AWS_ACCESS_KEY_ID secret is not configured"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "ERROR: AWS_SECRET_ACCESS_KEY secret is not configured"
            exit 1
          fi
          ACCESS_KEY=$(echo "${{ secrets.AWS_ACCESS_KEY_ID }}" | xargs)
          SECRET_KEY=$(echo "${{ secrets.AWS_SECRET_ACCESS_KEY }}" | xargs)
          SESSION_TOKEN=$(echo "${{ secrets.AWS_SESSION_TOKEN }}" | xargs)
          echo "AWS_ACCESS_KEY_ID=${ACCESS_KEY}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${SECRET_KEY}" >> $GITHUB_ENV
          if [ -n "${{ secrets.AWS_SESSION_TOKEN }}" ] && [ -n "${SESSION_TOKEN}" ]; then
            echo "AWS_SESSION_TOKEN=${SESSION_TOKEN}" >> $GITHUB_ENV
            echo "✅ AWS SSO/temporary credentials detected"
          fi
          echo "AWS_DEFAULT_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV
          echo "AWS_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV
          echo "✅ AWS credentials configured"

      - name: Install AWS Session Manager Plugin
        run: |
          echo "=== Installing AWS Session Manager Plugin to ~/bin ==="
          
          # Check if already installed
          if command -v session-manager-plugin >/dev/null 2>&1; then
            echo "✅ Session Manager Plugin is already installed:"
            session-manager-plugin --version
            exit 0
          fi
          
          echo "Downloading Session Manager Plugin..."
          LOCAL_RPM="rpm/session-manager-plugin.rpm"
          RPM_FILE="/tmp/session-manager-plugin.rpm"
          
          # Use local RPM if available
          if [ -f "$LOCAL_RPM" ]; then
            echo "✅ Found local RPM file"
            cp "$LOCAL_RPM" "$RPM_FILE"
          else
            PLUGIN_URL="https://s3.amazonaws.com/session-manager-downloads/plugin/latest/linux_64bit/session-manager-plugin.rpm"
            curl -fsSL "$PLUGIN_URL" -o "$RPM_FILE"
          fi
          
          # Verify cpio is available
          if ! command -v cpio >/dev/null 2>&1; then
            echo "❌ CRITICAL: cpio not found in PATH"
            echo "PATH: $PATH"
            ls -la ~/bin/ ~/.local/bin/ 2>/dev/null || true
            exit 1
          fi
          
          echo "✅ cpio is available: $(which cpio)"
          
          # Extract RPM to temporary directory
          echo "Extracting RPM using rpm2cpio + cpio..."
          EXTRACT_DIR=$(mktemp -d)
          cd "$EXTRACT_DIR"
          
          rpm2cpio "$RPM_FILE" | cpio -idmv 2>&1 | head -20
          
          # Find the binary
          BINARY_PATH=$(find "$EXTRACT_DIR" -name "session-manager-plugin" -type f | head -1)
          
          if [ -z "$BINARY_PATH" ]; then
            echo "❌ Binary not found after extraction"
            echo "Extract directory contents:"
            find "$EXTRACT_DIR" -type f | head -20
            exit 1
          fi
          
          echo "Found binary: $BINARY_PATH"
          
          # Copy to ~/bin
          cp "$BINARY_PATH" ~/bin/session-manager-plugin
          chmod +x ~/bin/session-manager-plugin
          
          # Verify
          if ~/bin/session-manager-plugin --version; then
            echo "✅ Session Manager Plugin installed successfully"
          else
            echo "❌ Installation verification failed"
            exit 1
          fi
          
          # Cleanup
          rm -rf "$EXTRACT_DIR" "$RPM_FILE"

      - name: Initialize Packer
        run: packer init aws-golden-image.pkr.hcl

      - name: Build Packer image
        run: |
          PACKER_BUILD_CMD="packer build -var=\"aws_region=${{ env.PKR_VAR_aws_region }}\""
          
          if [ -n "${{ env.PKR_VAR_iam_instance_profile }}" ]; then
            PACKER_BUILD_CMD="${PACKER_BUILD_CMD} -var=\"iam_instance_profile=${{ env.PKR_VAR_iam_instance_profile }}\""
          fi
          
          if [ -n "${{ env.PKR_VAR_vpc_id }}" ]; then
            PACKER_BUILD_CMD="${PACKER_BUILD_CMD} -var=\"vpc_id=${{ env.PKR_VAR_vpc_id }}\""
          fi
          
          if [ -n "${{ env.PKR_VAR_subnet_id }}" ]; then
            PACKER_BUILD_CMD="${PACKER_BUILD_CMD} -var=\"subnet_id=${{ env.PKR_VAR_subnet_id }}\""
          fi
          
          SECURITY_GROUP_IDS="${{ vars.SECURITY_GROUP_IDS }}"
          if [ -n "$SECURITY_GROUP_IDS" ]; then
            SG_HCL=$(echo "$SECURITY_GROUP_IDS" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed 's/^/"/;s/$/"/' | tr '\n' ',' | sed 's/,$//' | sed 's/^/[/;s/$/]/')
            VAR_FILE=$(mktemp --suffix=.hcl)
            echo "security_group_ids = $SG_HCL" > "$VAR_FILE"
            PACKER_BUILD_CMD="${PACKER_BUILD_CMD} -var-file=$VAR_FILE"
          fi
          
          PACKER_BUILD_CMD="${PACKER_BUILD_CMD} aws-golden-image.pkr.hcl"
          eval $PACKER_BUILD_CMD

      - name: Output AMI ID
        if: success()
        run: |
          echo "✅ AMI build completed successfully!"
          echo "Check AWS EC2 Console for the latest AMI"