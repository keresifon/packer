name: Build Amazon Linux 2023 Golden Image

 

on:

  workflow_dispatch:

    inputs:

      aws_region:

        description: 'AWS region'

        required: false

        default: 'us-east-2'

        type: string

      iam_instance_profile:

        description: 'IAM instance profile name for SSM (optional - Packer can create temporary one)'

        required: false

        default: ''

        type: string

  push:

    branches:

      - main

    paths:

      - '*.pkr.hcl'

      - '.github/workflows/**'

  pull_request:

    branches:

      - main

 

env:

  PKR_VAR_aws_region: ${{ github.event.inputs.aws_region || 'us-east-2' }}

  PKR_VAR_iam_instance_profile: ${{ vars.IAM_INSTANCE_PROFILE || github.event.inputs.iam_instance_profile || '' }}

  PKR_VAR_vpc_id: ${{ vars.VPC_ID || '' }}

  PKR_VAR_subnet_id: ${{ vars.SUBNET_ID || '' }}

  # PKR_VAR_security_group_ids is set conditionally in steps to avoid Packer parsing errors

 

jobs:

  validate:

    name: Validate Packer Template

    runs-on: ubuntu-latest

    permissions:

      contents: read

    steps:

      - name: Checkout code

        uses: actions/checkout@v4

 

      - name: Inspect Runner Environment

        run: |

          echo "=== Runner OS Information ==="

          uname -a

          cat /etc/os-release

          echo ""

          echo "=== Package Manager. ==="

          which dnf && dnf --version || echo "dnf not found"

          which yum && yum --version || echo "yum not found"

          echo ""

          echo "=== Available Shells ==="

          cat /etc/shells

          echo ""

          echo "=== Pre-installed Tools ==="

          echo "curl: $(which curl || echo 'not found')"

          echo "wget: $(which wget || echo 'not found')"

          echo "unzip: $(which unzip || echo 'not found')"

          echo "jq: $(which jq || echo 'not found')"

          echo "aws: $(which aws || echo 'not found')"

          echo "git: $(which git || echo 'not found')"

          echo ""

          echo "=== Environment Variables ==="

          env | grep -E '^(PATH|HOME|USER|SHELL|RUNNER)' | sort

          echo ""

          echo "=== PATH ==="

          echo $PATH

 

      - name: Install dependencies

        run: |

          # Check if packages are already installed

          if command -v jq >/dev/null 2>&1 && command -v unzip >/dev/null 2>&1 && command -v curl >/dev/null 2>&1; then

            echo "All required packages (jq, unzip, curl) are already installed"

            jq --version

            unzip -v | head -1

            curl --version | head -1

          else

            echo "Some packages missing, attempting installation..."

            # Try to install missing packages, but don't fail if dnf has issues

            dnf install -y jq unzip curl 2>&1 || {

              echo "dnf install encountered issues, checking what's available..."

              # Install jq manually if needed and dnf failed

              if ! command -v jq >/dev/null 2>&1; then

                echo "Installing jq from GitHub releases..."

                curl -L https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64 -o /tmp/jq

                chmod +x /tmp/jq

                mv /tmp/jq /usr/local/bin/jq || mv /tmp/jq ~/bin/jq || cp /tmp/jq ./jq

              fi

            }

            # Verify what we have

            echo "Final status:"

            command -v jq && jq --version || echo "jq: not available"

            command -v unzip && unzip -v | head -1 || echo "unzip: not available"

            command -v curl && curl --version | head -1 || echo "curl: not available"

          fi

 

      - name: Setup Packer

        run: |

          PACKER_VERSION="1.10.0"

          # Download and install Packer

          curl -fsSL https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip -o packer.zip

          unzip -q packer.zip

          mv packer /usr/local/bin/

          rm packer.zip

          packer version

 

      - name: Clear AWS credential caches

        run: |

          echo "=== Clearing potential AWS credential caches ==="

          # Clear AWS CLI cache (if AWS CLI is installed)

          rm -rf ~/.aws/cli/cache 2>/dev/null || true

          rm -rf ~/.aws/sso/cache 2>/dev/null || true

          rm -rf ~/.aws/credentials 2>/dev/null || true

          rm -rf ~/.aws/config 2>/dev/null || true

          # Unset any existing AWS environment variables to ensure fresh credentials

          unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_SECURITY_TOKEN AWS_DEFAULT_REGION AWS_REGION || true

          echo "✅ Caches cleared"

 

      - name: Configure AWS Credentials

        run: |

          # Verify secrets are configured (before setting to GITHUB_ENV)

          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then

            echo "ERROR: AWS_ACCESS_KEY_ID secret is not configured in GitHub Secrets."

            echo "Please go to Settings > Secrets and variables > Actions and add AWS_ACCESS_KEY_ID"

            exit 1

          fi

          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then

            echo "ERROR: AWS_SECRET_ACCESS_KEY secret is not configured in GitHub Secrets."

            echo "Please go to Settings > Secrets and variables > Actions and add AWS_SECRET_ACCESS_KEY"

            exit 1

          fi

          # Trim whitespace and set AWS credentials as environment variables for subsequent steps

          ACCESS_KEY=$(echo "${{ secrets.AWS_ACCESS_KEY_ID }}" | xargs)

          SECRET_KEY=$(echo "${{ secrets.AWS_SECRET_ACCESS_KEY }}" | xargs)

          SESSION_TOKEN=$(echo "${{ secrets.AWS_SESSION_TOKEN }}" | xargs)

          echo "AWS_ACCESS_KEY_ID=${ACCESS_KEY}" >> $GITHUB_ENV

          echo "AWS_SECRET_ACCESS_KEY=${SECRET_KEY}" >> $GITHUB_ENV

          # AWS SSO and temporary credentials require AWS_SESSION_TOKEN

          if [ -n "${{ secrets.AWS_SESSION_TOKEN }}" ] && [ -n "${SESSION_TOKEN}" ]; then

            echo "AWS_SESSION_TOKEN=${SESSION_TOKEN}" >> $GITHUB_ENV

            echo "✅ AWS SSO/temporary credentials detected (with session token)"

          else

            echo "ℹ️  No AWS_SESSION_TOKEN provided - using long-term credentials"

          fi

          echo "AWS_DEFAULT_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV

          echo "AWS_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV

          # Basic format validation (without exposing values)

          ACCESS_KEY_LEN=${#ACCESS_KEY}

          SECRET_KEY_LEN=${#SECRET_KEY}

          if [ $ACCESS_KEY_LEN -lt 16 ] || [ $ACCESS_KEY_LEN -gt 128 ]; then

            echo "WARNING: AWS_ACCESS_KEY_ID length is ${ACCESS_KEY_LEN} characters (expected 16-128)"

            echo "This may indicate an invalid or incorrectly formatted access key"

          fi

          if [ $SECRET_KEY_LEN -lt 40 ]; then

            echo "WARNING: AWS_SECRET_ACCESS_KEY length is ${SECRET_KEY_LEN} characters (expected 40+)"

            echo "This may indicate an invalid or incorrectly formatted secret key"

          fi

          echo "✅ AWS credentials configured successfully"

          echo "AWS Region: ${{ env.PKR_VAR_aws_region }}"

          echo "Note: Credentials will be validated by Packer during execution"

          echo ""

          echo "If you see 'InvalidClientTokenId' errors, please verify:"

          echo "1. AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY secrets are set correctly"

          echo "2. For AWS SSO: AWS_SESSION_TOKEN secret is also set (required for SSO credentials)"

          echo "3. Credentials are active and not expired (SSO tokens expire after ~1 hour)"

          echo "4. IAM user/role has required permissions (ec2:DescribeImages, ec2:RunInstances, etc.)"

          echo "5. No extra whitespace or newlines in the secret values"

 

      - name: Verify credentials are set correctly

        run: |

          echo "=== Verifying credentials are set ==="

          if [ -n "$AWS_ACCESS_KEY_ID" ]; then

            echo "✅ AWS_ACCESS_KEY_ID is set (length: ${#AWS_ACCESS_KEY_ID} chars)"

            echo "   Preview: ${AWS_ACCESS_KEY_ID:0:4}...${AWS_ACCESS_KEY_ID: -4}"

          else

            echo "❌ AWS_ACCESS_KEY_ID is NOT set"

          fi

          if [ -n "$AWS_SECRET_ACCESS_KEY" ]; then

            echo "✅ AWS_SECRET_ACCESS_KEY is set (length: ${#AWS_SECRET_ACCESS_KEY} chars)"

          else

            echo "❌ AWS_SECRET_ACCESS_KEY is NOT set"

          fi

          if [ -n "$AWS_SESSION_TOKEN" ]; then

            echo "✅ AWS_SESSION_TOKEN is set (length: ${#AWS_SESSION_TOKEN} chars)"

            echo "   Token preview: ${AWS_SESSION_TOKEN:0:20}...${AWS_SESSION_TOKEN: -10}"

          else

            echo "ℹ️  AWS_SESSION_TOKEN is NOT set (using long-term credentials)"

          fi

          echo "Region: ${AWS_DEFAULT_REGION:-'not set'}"

 

      - name: Initialize Packer

        run: packer init aws-golden-image.pkr.hcl

 

      - name: Validate Packer template

        run: packer validate aws-golden-image.pkr.hcl

 

  build:

    name: Build AMI

    needs: validate

    runs-on: ubuntu-latest

    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')

    permissions:

      contents: read

    steps:

      - name: Checkout code

        uses: actions/checkout@v4

 

      - name: Install dependencies

        run: |

          # Check if packages are already installed

          if command -v jq >/dev/null 2>&1 && command -v unzip >/dev/null 2>&1 && command -v curl >/dev/null 2>&1; then

            echo "All required packages (jq, unzip, curl) are already installed"

            jq --version

            unzip -v | head -1

            curl --version | head -1

          else

            echo "Some packages missing, attempting installation..."

            # Try to install missing packages, but don't fail if dnf has issues

            dnf install -y jq unzip curl 2>&1 || {

              echo "dnf install encountered issues, checking what's available..."

              # Install jq manually if needed and dnf failed

              if ! command -v jq >/dev/null 2>&1; then

                echo "Installing jq from GitHub releases..."

                curl -L https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64 -o /tmp/jq

                chmod +x /tmp/jq

                mv /tmp/jq /usr/local/bin/jq || mv /tmp/jq ~/bin/jq || cp /tmp/jq ./jq

              fi

            }

            # Verify what we have

            echo "Final status:"

            command -v jq && jq --version || echo "jq: not available"

            command -v unzip && unzip -v | head -1 || echo "unzip: not available"

            command -v curl && curl --version | head -1 || echo "curl: not available"

          fi

 

      - name: Setup Packer

        run: |

          PACKER_VERSION="1.10.0"

          # Download and install Packer

          curl -fsSL https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip -o packer.zip

          unzip -q packer.zip

          mv packer /usr/local/bin/

          rm packer.zip

          packer version

 

      - name: Clear AWS credential caches

        run: |

          echo "=== Clearing potential AWS credential caches ==="

          # Clear AWS CLI cache (if AWS CLI is installed)

          rm -rf ~/.aws/cli/cache 2>/dev/null || true

          rm -rf ~/.aws/sso/cache 2>/dev/null || true

          rm -rf ~/.aws/credentials 2>/dev/null || true

          rm -rf ~/.aws/config 2>/dev/null || true

          # Unset any existing AWS environment variables to ensure fresh credentials

          unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_SECURITY_TOKEN AWS_DEFAULT_REGION AWS_REGION || true

          echo "✅ Caches cleared"

 

      - name: Configure AWS Credentials

        run: |

          # Verify secrets are configured (before setting to GITHUB_ENV)

          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then

            echo "ERROR: AWS_ACCESS_KEY_ID secret is not configured in GitHub Secrets."

            echo "Please go to Settings > Secrets and variables > Actions and add AWS_ACCESS_KEY_ID"

            exit 1

          fi

          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then

            echo "ERROR: AWS_SECRET_ACCESS_KEY secret is not configured in GitHub Secrets."

            echo "Please go to Settings > Secrets and variables > Actions and add AWS_SECRET_ACCESS_KEY"

            exit 1

          fi

          # Trim whitespace and set AWS credentials as environment variables for subsequent steps

          ACCESS_KEY=$(echo "${{ secrets.AWS_ACCESS_KEY_ID }}" | xargs)

          SECRET_KEY=$(echo "${{ secrets.AWS_SECRET_ACCESS_KEY }}" | xargs)

          SESSION_TOKEN=$(echo "${{ secrets.AWS_SESSION_TOKEN }}" | xargs)

          echo "AWS_ACCESS_KEY_ID=${ACCESS_KEY}" >> $GITHUB_ENV

          echo "AWS_SECRET_ACCESS_KEY=${SECRET_KEY}" >> $GITHUB_ENV

          # AWS SSO and temporary credentials require AWS_SESSION_TOKEN

          if [ -n "${{ secrets.AWS_SESSION_TOKEN }}" ] && [ -n "${SESSION_TOKEN}" ]; then

            echo "AWS_SESSION_TOKEN=${SESSION_TOKEN}" >> $GITHUB_ENV

            echo "✅ AWS SSO/temporary credentials detected (with session token)"

          else

            echo "ℹ️  No AWS_SESSION_TOKEN provided - using long-term credentials"

          fi

          echo "AWS_DEFAULT_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV

          echo "AWS_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV

          # Basic format validation (without exposing values)

          ACCESS_KEY_LEN=${#ACCESS_KEY}

          SECRET_KEY_LEN=${#SECRET_KEY}

          if [ $ACCESS_KEY_LEN -lt 16 ] || [ $ACCESS_KEY_LEN -gt 128 ]; then

            echo "WARNING: AWS_ACCESS_KEY_ID length is ${ACCESS_KEY_LEN} characters (expected 16-128)"

            echo "This may indicate an invalid or incorrectly formatted access key"

          fi

          if [ $SECRET_KEY_LEN -lt 40 ]; then

            echo "WARNING: AWS_SECRET_ACCESS_KEY length is ${SECRET_KEY_LEN} characters (expected 40+)"

            echo "This may indicate an invalid or incorrectly formatted secret key"

          fi

          echo "✅ AWS credentials configured successfully"

          echo "AWS Region: ${{ env.PKR_VAR_aws_region }}"

          echo "Note: Credentials will be validated by Packer during execution"

          echo ""

          echo "If you see 'InvalidClientTokenId' errors, please verify:"

          echo "1. AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY secrets are set correctly"

          echo "2. For AWS SSO: AWS_SESSION_TOKEN secret is also set (required for SSO credentials)"

          echo "3. Credentials are active and not expired (SSO tokens expire after ~1 hour)"

          echo "4. IAM user/role has required permissions (ec2:DescribeImages, ec2:RunInstances, etc.)"

          echo "5. No extra whitespace or newlines in the secret values"

 

      - name: Verify credentials are set correctly

        run: |

          echo "=== Verifying credentials are set ==="

          if [ -n "$AWS_ACCESS_KEY_ID" ]; then

            echo "✅ AWS_ACCESS_KEY_ID is set (length: ${#AWS_ACCESS_KEY_ID} chars)"

            echo "   Preview: ${AWS_ACCESS_KEY_ID:0:4}...${AWS_ACCESS_KEY_ID: -4}"

          else

            echo "❌ AWS_ACCESS_KEY_ID is NOT set"

          fi

          if [ -n "$AWS_SECRET_ACCESS_KEY" ]; then

            echo "✅ AWS_SECRET_ACCESS_KEY is set (length: ${#AWS_SECRET_ACCESS_KEY} chars)"

          else

            echo "❌ AWS_SECRET_ACCESS_KEY is NOT set"

          fi

          if [ -n "$AWS_SESSION_TOKEN" ]; then

            echo "✅ AWS_SESSION_TOKEN is set (length: ${#AWS_SESSION_TOKEN} chars)"

            echo "   Token preview: ${AWS_SESSION_TOKEN:0:20}...${AWS_SESSION_TOKEN: -10}"

          else

            echo "ℹ️  AWS_SESSION_TOKEN is NOT set (using long-term credentials)"

          fi

          echo "Region: ${AWS_DEFAULT_REGION:-'not set'}"

 

      - name: Initialize Packer

        run: packer init aws-golden-image.pkr.hcl

 

      - name: Validate VPC and Subnet Configuration

        run: |

          VPC_ID="${{ env.PKR_VAR_vpc_id }}"

          SUBNET_ID="${{ env.PKR_VAR_subnet_id }}"

          REGION="${{ env.PKR_VAR_aws_region }}"

          IAM_PROFILE="${{ env.PKR_VAR_iam_instance_profile }}"

          echo "=== VPC and Subnet Configuration ==="

          echo "Region: ${REGION}"

          echo "VPC ID: ${VPC_ID:-'Not specified (will use default VPC if available)'}"

          echo "Subnet ID: ${SUBNET_ID:-'Not specified (will use default subnet if available)'}"

          echo "IAM Instance Profile: ${IAM_PROFILE:-'Not specified (Packer will create temporary one)'}"

          echo ""

          # Validation: If subnet is specified, VPC must also be specified

          if [ -n "$SUBNET_ID" ] && [ -z "$VPC_ID" ]; then

            echo "❌ ERROR: Subnet ID is specified but VPC ID is not."

            echo "Packer requires both VPC ID and Subnet ID to be specified together."

            echo "The subnet must belong to the specified VPC."

            echo ""

            echo "Solution: Set VPC_ID repository variable, or remove SUBNET_ID to use default VPC/subnet."

            exit 1

          fi

          if [ -n "$VPC_ID" ] && [ -n "$SUBNET_ID" ]; then

            echo "✅ Both VPC and Subnet IDs are configured"

            echo "⚠️  Validating subnet exists in specified region and VPC..."

            # Verify subnet exists and belongs to the VPC

            SUBNET_VPC_ID=$(aws ec2 describe-subnets --subnet-ids "$SUBNET_ID" --region "$REGION" --query 'Subnets[0].VpcId' --output text 2>&1)

            if [ $? -ne 0 ]; then

              echo "❌ ERROR: Failed to describe subnet '$SUBNET_ID' in region '$REGION'"

              echo "   Error details: $SUBNET_VPC_ID"

              echo ""

              echo "   Possible causes:"

              echo "   1. Subnet does not exist in region '$REGION'"

              echo "   2. Subnet ID is incorrect"

              echo "   3. AWS credentials don't have ec2:DescribeSubnets permission"

              echo ""

              echo "   To list available subnets in the VPC, run:"

              echo "     aws ec2 describe-subnets --filters \"Name=vpc-id,Values=$VPC_ID\" --region $REGION --query 'Subnets[*].[SubnetId,AvailabilityZone]' --output table"

              exit 1

            fi

            if [ "$SUBNET_VPC_ID" != "$VPC_ID" ]; then

              echo "❌ ERROR: Subnet '$SUBNET_ID' belongs to VPC '$SUBNET_VPC_ID', not the specified VPC '$VPC_ID'"

              echo ""

              echo "   Please verify:"

              echo "   1. The subnet ID is correct"

              echo "   2. The VPC ID matches the subnet's VPC"

              exit 1

            fi

            echo "✅ Subnet '$SUBNET_ID' verified in VPC '$VPC_ID' in region '$REGION'"

          fi

          echo ""

          echo "=== SSM Session Manager Configuration ==="

          if [ -n "$IAM_PROFILE" ]; then

            echo "✅ Using IAM instance profile: $IAM_PROFILE"

            echo "   Source: GitHub repository variable IAM_INSTANCE_PROFILE or workflow input"

            echo "   Ensure it has AmazonSSMManagedInstanceCore policy attached"

          else

            echo "ℹ️  No IAM instance profile specified"

            echo "   Packer will create a temporary instance profile with SSM permissions"

            echo "   To use a pre-created profile, set GitHub repository variable: IAM_INSTANCE_PROFILE"

            echo "   Required IAM permissions for Packer (if creating temporary profile):"

            echo "   - iam:CreateInstanceProfile"

            echo "   - iam:AddRoleToInstanceProfile"

            echo "   - iam:PassRole"

            echo "   - iam:CreateRole"

            echo "   - iam:AttachRolePolicy"

          fi

          echo ""

          echo "=== Private Subnet Requirements for SSM ==="

          if [ -n "$SUBNET_ID" ]; then

            echo "⚠️  IMPORTANT: Instance will be launched in a private subnet"

            echo ""

            echo "   For SSM Session Manager to work in private subnets, ensure:"

            echo ""

            echo "   1. Security Group:"

            echo "      - Packer WILL auto-create a security group if not specified"

            echo "      - Packer CANNOT automatically add outbound HTTPS (443) rules to temporary SGs"

            echo "      - AWS security groups allow ALL outbound by default (unless restricted)"

            echo "      - Packer's auto-created SG MIGHT work if default outbound rules apply"

            echo "      - RECOMMENDED: Pre-create a security group with explicit outbound HTTPS (443) rule"

            echo "      - Set GitHub repository variable: SECURITY_GROUP_IDS (comma-separated)"

            echo "      - Example: SECURITY_GROUP_IDS=sg-1234567890abcdef0"

            echo "      - This ensures SSM works reliably in private subnets"

            echo ""

            echo "   2. Network Connectivity (choose one):"

            echo "      Option A: NAT Gateway"

            echo "        - Route table routes 0.0.0.0/0 to NAT Gateway"

            echo "        - Security group allows outbound HTTPS (443) to 0.0.0.0/0"

            echo ""

            echo "      Option B: VPC Endpoints (for fully isolated subnets)"

            echo "        - Create VPC endpoints for:"

            echo "          * com.amazonaws.${REGION}.ssm (SSM service)"

            echo "          * com.amazonaws.${REGION}.ssmmessages (SSM messages)"

            echo "          * com.amazonaws.${REGION}.ec2 (EC2 API)"

            echo "        - Security group allows outbound HTTPS (443) to VPC endpoints"

            echo "        - Route table has routes to VPC endpoints"

            echo ""

            echo "   3. Verify IAM Instance Profile:"

            echo "      - Must have AmazonSSMManagedInstanceCore policy"

            echo "      - Currently using: ${IAM_PROFILE:-'Packer will create temporary one'}"

            echo ""

            echo "   Troubleshooting:"

            echo "      - If SSM fails, check Packer's auto-created security group outbound rules"

            echo "      - Default AWS security groups allow all outbound, but verify this"

            echo "      - Pre-creating a security group with explicit HTTPS (443) rule is most reliable"

          fi

 

      - name: Build Packer image

        env:

          # Only set PKR_VAR_security_group_ids if it has a value to avoid Packer parsing errors

          PKR_VAR_security_group_ids: ${{ vars.SECURITY_GROUP_IDS != '' && vars.SECURITY_GROUP_IDS || '' }}

        run: |

          PACKER_BUILD_CMD="packer build \

            -var=\"aws_region=${{ env.PKR_VAR_aws_region }}\""

          # Add IAM instance profile variable if provided

          if [ -n "${{ env.PKR_VAR_iam_instance_profile }}" ]; then

            PACKER_BUILD_CMD="${PACKER_BUILD_CMD} -var=\"iam_instance_profile=${{ env.PKR_VAR_iam_instance_profile }}\""

            echo "Using IAM Instance Profile: ${{ env.PKR_VAR_iam_instance_profile }}"

          fi

          # Add VPC and subnet variables if provided

          # Note: If subnet_id is provided, vpc_id should also be provided

          if [ -n "${{ env.PKR_VAR_vpc_id }}" ]; then

            PACKER_BUILD_CMD="${PACKER_BUILD_CMD} -var=\"vpc_id=${{ env.PKR_VAR_vpc_id }}\""

            echo "Using VPC ID: ${{ env.PKR_VAR_vpc_id }}"

          fi

          if [ -n "${{ env.PKR_VAR_subnet_id }}" ]; then

            PACKER_BUILD_CMD="${PACKER_BUILD_CMD} -var=\"subnet_id=${{ env.PKR_VAR_subnet_id }}\""

            echo "Using Subnet ID: ${{ env.PKR_VAR_subnet_id }}"

          fi

          # Add security group IDs if provided (comma-separated string converted to JSON array)

          if [ -n "${PKR_VAR_security_group_ids}" ]; then

            # Convert comma-separated string to JSON array format

            SG_IDS="${PKR_VAR_security_group_ids}"

            # Remove spaces and create JSON array

            SG_JSON=$(echo "$SG_IDS" | tr ',' '\n' | sed 's/^/"/;s/$/"/' | tr '\n' ',' | sed 's/,$//' | sed 's/^/[/;s/$/]/')

            PACKER_BUILD_CMD="${PACKER_BUILD_CMD} -var=\"security_group_ids=$SG_JSON\""

            echo "Using Security Group IDs: ${PKR_VAR_security_group_ids}"

          fi

          PACKER_BUILD_CMD="${PACKER_BUILD_CMD} aws-golden-image.pkr.hcl"

          eval $PACKER_BUILD_CMD

 

      - name: Output AMI ID

        if: success()

        run: |

          echo "AMI build completed successfully!"

          echo "Check AWS EC2 Console for the latest AMI"