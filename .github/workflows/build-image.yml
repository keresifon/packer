name: Build Ubuntu Golden Image

on:
  workflow_dispatch:
    inputs:
      ubuntu_version:
        description: 'Ubuntu version to build'
        required: false
        default: '22.04'
        type: choice
        options:
          - '22.04'
          - '20.04'
      aws_region:
        description: 'AWS region'
        required: false
        default: 'us-east-1'
        type: string
  push:
    branches:
      - main
    paths:
      - '*.pkr.hcl'
      - '.github/workflows/**'
  pull_request:
    branches:
      - main

env:
  PKR_VAR_aws_region: ${{ github.event.inputs.aws_region || 'us-east-1' }}
  PKR_VAR_ubuntu_version: ${{ github.event.inputs.ubuntu_version || '22.04' }}

jobs:
  validate:
    name: Validate Packer Template
    runs-on: terraform
    permissions:
      id-token: write  # Required for OIDC
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Inspect Runner Environment
        run: |
          echo "=== Runner OS Information ==="
          uname -a
          cat /etc/os-release
          echo ""
          echo "=== Package Manager ==="
          which dnf && dnf --version || echo "dnf not found"
          which yum && yum --version || echo "yum not found"
          echo ""
          echo "=== Available Shells ==="
          cat /etc/shells
          echo ""
          echo "=== Pre-installed Tools ==="
          echo "curl: $(which curl || echo 'not found')"
          echo "wget: $(which wget || echo 'not found')"
          echo "unzip: $(which unzip || echo 'not found')"
          echo "jq: $(which jq || echo 'not found')"
          echo "aws: $(which aws || echo 'not found')"
          echo "git: $(which git || echo 'not found')"
          echo ""
          echo "=== Environment Variables ==="
          env | grep -E '^(PATH|HOME|USER|SHELL|RUNNER)' | sort
          echo ""
          echo "=== PATH ==="
          echo $PATH

      - name: Install dependencies
        run: |
          # Check if packages are already installed
          if command -v jq >/dev/null 2>&1 && command -v unzip >/dev/null 2>&1 && command -v curl >/dev/null 2>&1; then
            echo "All required packages (jq, unzip, curl) are already installed"
            jq --version
            unzip -v | head -1
            curl --version | head -1
          else
            echo "Some packages missing, attempting installation..."
            # Try to install missing packages, but don't fail if dnf has issues
             dnf install -y jq unzip curl 2>&1 || {
              echo "dnf install encountered issues, checking what's available..."
              # Install jq manually if needed and dnf failed
              if ! command -v jq >/dev/null 2>&1; then
                echo "Installing jq from GitHub releases..."
                curl -L https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64 -o /tmp/jq
                chmod +x /tmp/jq
                 mv /tmp/jq /usr/local/bin/jq || mv /tmp/jq ~/bin/jq || cp /tmp/jq ./jq
              fi
            }
            # Verify what we have
            echo "Final status:"
            command -v jq && jq --version || echo "jq: not available"
            command -v unzip && unzip -v | head -1 || echo "unzip: not available"
            command -v curl && curl --version | head -1 || echo "curl: not available"
          fi

      - name: Setup Packer
        run: |
          PACKER_VERSION="1.10.0"
          # Download and install Packer
          curl -fsSL https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip -o packer.zip
          unzip -q packer.zip
           mv packer /usr/local/bin/
          rm packer.zip
          packer version

      - name: Install AWS CLI
        run: |
          # Check if AWS CLI is already installed
          if command -v aws >/dev/null 2>&1; then
            echo "AWS CLI is already installed"
            aws --version
          else
            echo "Installing AWS CLI v2..."
            # Download AWS CLI v2 installer
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -q awscliv2.zip
            # Install AWS CLI
             ./aws/install
            # Clean up
            rm -rf aws awscliv2.zip
            # Verify installation
            aws --version
          fi

      - name: Configure AWS Credentials (OIDC)
        run: |
          # Request OIDC token from GitHub Actions
          OIDC_TOKEN=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=sts.amazonaws.com" | jq -r '.value')
          
          # Assume AWS role using OIDC token
          AWS_CREDS=$(aws sts assume-role-with-web-identity \
            --role-arn ${{ secrets.AWS_ROLE_ARN }} \
            --role-session-name github-actions-packer-validate \
            --web-identity-token "$OIDC_TOKEN" \
            --duration-seconds 3600 \
            --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' \
            --output text)
          
          # Set AWS credentials as environment variables for subsequent steps
          echo "AWS_ACCESS_KEY_ID=$(echo $AWS_CREDS | awk '{print $1}')" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=$(echo $AWS_CREDS | awk '{print $2}')" >> $GITHUB_ENV
          echo "AWS_SESSION_TOKEN=$(echo $AWS_CREDS | awk '{print $3}')" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV
          echo "AWS_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV
          
          # Verify AWS credentials
          aws sts get-caller-identity

      - name: Initialize Packer
        run: packer init ubuntu-golden-image.pkr.hcl

      - name: Validate Packer template
        run: packer validate ubuntu-golden-image.pkr.hcl

  build:
    name: Build AMI
    needs: validate
    runs-on: terraform
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    permissions:
      id-token: write  # Required for OIDC
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          # Check if packages are already installed
          if command -v jq >/dev/null 2>&1 && command -v unzip >/dev/null 2>&1 && command -v curl >/dev/null 2>&1; then
            echo "All required packages (jq, unzip, curl) are already installed"
            jq --version
            unzip -v | head -1
            curl --version | head -1
          else
            echo "Some packages missing, attempting installation..."
            # Try to install missing packages, but don't fail if dnf has issues
             dnf install -y jq unzip curl 2>&1 || {
              echo "dnf install encountered issues, checking what's available..."
              # Install jq manually if needed and dnf failed
              if ! command -v jq >/dev/null 2>&1; then
                echo "Installing jq from GitHub releases..."
                curl -L https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64 -o /tmp/jq
                chmod +x /tmp/jq
                 mv /tmp/jq /usr/local/bin/jq || mv /tmp/jq ~/bin/jq || cp /tmp/jq ./jq
              fi
            }
            # Verify what we have
            echo "Final status:"
            command -v jq && jq --version || echo "jq: not available"
            command -v unzip && unzip -v | head -1 || echo "unzip: not available"
            command -v curl && curl --version | head -1 || echo "curl: not available"
          fi

      - name: Setup Packer
        run: |
          PACKER_VERSION="1.10.0"
          # Download and install Packer
          curl -fsSL https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip -o packer.zip
          unzip -q packer.zip
           mv packer /usr/local/bin/
          rm packer.zip
          packer version

      - name: Install AWS CLI
        run: |
          # Check if AWS CLI is already installed
          if command -v aws >/dev/null 2>&1; then
            echo "AWS CLI is already installed"
            aws --version
          else
            echo "Installing AWS CLI v2..."
            # Download AWS CLI v2 installer
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -q awscliv2.zip
            # Install AWS CLI
             ./aws/install
            # Clean up
            rm -rf aws awscliv2.zip
            # Verify installation
            aws --version
          fi

      - name: Configure AWS Credentials (OIDC)
        run: |
          # Request OIDC token from GitHub Actions
          OIDC_TOKEN=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=sts.amazonaws.com" | jq -r '.value')
          
          # Assume AWS role using OIDC token
          AWS_CREDS=$(aws sts assume-role-with-web-identity \
            --role-arn ${{ secrets.AWS_ROLE_ARN }} \
            --role-session-name github-actions-packer-build \
            --web-identity-token "$OIDC_TOKEN" \
            --duration-seconds 3600 \
            --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' \
            --output text)
          
          # Set AWS credentials as environment variables for subsequent steps
          echo "AWS_ACCESS_KEY_ID=$(echo $AWS_CREDS | awk '{print $1}')" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=$(echo $AWS_CREDS | awk '{print $2}')" >> $GITHUB_ENV
          echo "AWS_SESSION_TOKEN=$(echo $AWS_CREDS | awk '{print $3}')" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV
          echo "AWS_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV
          
          # Verify AWS credentials
          aws sts get-caller-identity

      - name: Initialize Packer
        run: packer init ubuntu-golden-image.pkr.hcl

      - name: Build Packer image
        run: |
          packer build \
            -var="aws_region=${{ env.PKR_VAR_aws_region }}" \
            -var="ubuntu_version=${{ env.PKR_VAR_ubuntu_version }}" \
            ubuntu-golden-image.pkr.hcl

      - name: Output AMI ID
        if: success()
        run: |
          echo "AMI build completed successfully!"
          echo "Check AWS EC2 Console for the latest AMI"

