name: Build Amazon Linux 2023 Golden Image

 

on:

  workflow_dispatch:

    inputs:

      aws_region:

        description: 'AWS region'

        required: false

        default: 'us-east-1'

        type: string

      iam_instance_profile:

        description: 'IAM instance profile name for SSM (optional - Packer can create temporary one)'

        required: false

        default: ''

        type: string

  push:

    branches:

      - main

    paths:

      - '*.pkr.hcl'

      - '.github/workflows/**'

  pull_request:

    branches:

      - main

 

env:

  PKR_VAR_aws_region: ${{ github.event.inputs.aws_region || 'us-east-1' }}

  PKR_VAR_iam_instance_profile: ${{ vars.IAM_INSTANCE_PROFILE || github.event.inputs.iam_instance_profile || '' }}

  PKR_VAR_vpc_id: ${{ vars.VPC_ID || '' }}

  PKR_VAR_subnet_id: ${{ vars.SUBNET_ID || '' }}

  # PKR_VAR_security_group_ids is set conditionally in steps to avoid Packer parsing errors

 

jobs:

  validate:

    name: Validate Packer Template

    runs-on: terraform

    permissions:

      contents: read

    steps:

      - name: Checkout code

        uses: actions/checkout@v4

 

      - name: Inspect Runner Environment

        run: |

          echo "=== Runner OS Information ==="

          uname -a

          cat /etc/os-release

          echo ""

          echo "=== Package Manager. ==="

          which dnf && dnf --version || echo "dnf not found"

          which yum && yum --version || echo "yum not found"

          echo ""

          echo "=== Available Shells ==="

          cat /etc/shells

          echo ""

          echo "=== Pre-installed Tools ==="

          echo "curl: $(which curl || echo 'not found')"

          echo "wget: $(which wget || echo 'not found')"

          echo "unzip: $(which unzip || echo 'not found')"

          echo "jq: $(which jq || echo 'not found')"

          echo "aws: $(which aws || echo 'not found')"

          echo "git: $(which git || echo 'not found')"

          echo ""

          echo "=== Environment Variables ==="

          env | grep -E '^(PATH|HOME|USER|SHELL|RUNNER)' | sort

          echo ""

          echo "=== PATH ==="

          echo $PATH

 

      - name: Install dependencies

        run: |

          # Check if packages are already installed

          if command -v jq >/dev/null 2>&1 && command -v unzip >/dev/null 2>&1 && command -v curl >/dev/null 2>&1; then

            echo "All required packages (jq, unzip, curl) are already installed"

            jq --version

            unzip -v | head -1

            curl --version | head -1

          else

            echo "Some packages missing, attempting installation..."

            # Try to install missing packages, but don't fail if dnf has issues

            dnf install -y jq unzip curl 2>&1 || {

              echo "dnf install encountered issues, checking what's available..."

              # Install jq manually if needed and dnf failed

              if ! command -v jq >/dev/null 2>&1; then

                echo "Installing jq from GitHub releases..."

                curl -L https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64 -o /tmp/jq

                chmod +x /tmp/jq

                mv /tmp/jq /usr/local/bin/jq || mv /tmp/jq ~/bin/jq || cp /tmp/jq ./jq

              fi

            }

            # Verify what we have

            echo "Final status:"

            command -v jq && jq --version || echo "jq: not available"

            command -v unzip && unzip -v | head -1 || echo "unzip: not available"

            command -v curl && curl --version | head -1 || echo "curl: not available"

          fi

 

      - name: Setup Packer

        run: |

          PACKER_VERSION="1.10.0"

          # Download and install Packer

          curl -fsSL https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip -o packer.zip

          unzip -q packer.zip

          mv packer /usr/local/bin/

          rm packer.zip

          packer version

 

      - name: Clear AWS credential caches

        run: |

          echo "=== Clearing potential AWS credential caches ==="

          # Clear AWS CLI cache (if AWS CLI is installed)

          rm -rf ~/.aws/cli/cache 2>/dev/null || true

          rm -rf ~/.aws/sso/cache 2>/dev/null || true

          rm -rf ~/.aws/credentials 2>/dev/null || true

          rm -rf ~/.aws/config 2>/dev/null || true

          # Unset any existing AWS environment variables to ensure fresh credentials

          unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_SECURITY_TOKEN AWS_DEFAULT_REGION AWS_REGION || true

          echo "✅ Caches cleared"

 

      - name: Configure AWS Credentials

        run: |

          # Verify secrets are configured (before setting to GITHUB_ENV)

          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then

            echo "ERROR: AWS_ACCESS_KEY_ID secret is not configured in GitHub Secrets."

            echo "Please go to Settings > Secrets and variables > Actions and add AWS_ACCESS_KEY_ID"

            exit 1

          fi

          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then

            echo "ERROR: AWS_SECRET_ACCESS_KEY secret is not configured in GitHub Secrets."

            echo "Please go to Settings > Secrets and variables > Actions and add AWS_SECRET_ACCESS_KEY"

            exit 1

          fi

          # Trim whitespace and set AWS credentials as environment variables for subsequent steps

          ACCESS_KEY=$(echo "${{ secrets.AWS_ACCESS_KEY_ID }}" | xargs)

          SECRET_KEY=$(echo "${{ secrets.AWS_SECRET_ACCESS_KEY }}" | xargs)

          SESSION_TOKEN=$(echo "${{ secrets.AWS_SESSION_TOKEN }}" | xargs)

          echo "AWS_ACCESS_KEY_ID=${ACCESS_KEY}" >> $GITHUB_ENV

          echo "AWS_SECRET_ACCESS_KEY=${SECRET_KEY}" >> $GITHUB_ENV

          # AWS SSO and temporary credentials require AWS_SESSION_TOKEN

          if [ -n "${{ secrets.AWS_SESSION_TOKEN }}" ] && [ -n "${SESSION_TOKEN}" ]; then

            echo "AWS_SESSION_TOKEN=${SESSION_TOKEN}" >> $GITHUB_ENV

            echo "✅ AWS SSO/temporary credentials detected (with session token)"

          else

            echo "ℹ️  No AWS_SESSION_TOKEN provided - using long-term credentials"

          fi

          echo "AWS_DEFAULT_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV

          echo "AWS_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV

          # Basic format validation (without exposing values)

          ACCESS_KEY_LEN=${#ACCESS_KEY}

          SECRET_KEY_LEN=${#SECRET_KEY}

          if [ $ACCESS_KEY_LEN -lt 16 ] || [ $ACCESS_KEY_LEN -gt 128 ]; then

            echo "WARNING: AWS_ACCESS_KEY_ID length is ${ACCESS_KEY_LEN} characters (expected 16-128)"

            echo "This may indicate an invalid or incorrectly formatted access key"

          fi

          if [ $SECRET_KEY_LEN -lt 40 ]; then

            echo "WARNING: AWS_SECRET_ACCESS_KEY length is ${SECRET_KEY_LEN} characters (expected 40+)"

            echo "This may indicate an invalid or incorrectly formatted secret key"

          fi

          echo "✅ AWS credentials configured successfully"

          echo "AWS Region: ${{ env.PKR_VAR_aws_region }}"

          echo "Note: Credentials will be validated by Packer during execution"

          echo ""

          echo "If you see 'InvalidClientTokenId' errors, please verify:"

          echo "1. AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY secrets are set correctly"

          echo "2. For AWS SSO: AWS_SESSION_TOKEN secret is also set (required for SSO credentials)"

          echo "3. Credentials are active and not expired (SSO tokens expire after ~1 hour)"

          echo "4. IAM user/role has required permissions (ec2:DescribeImages, ec2:RunInstances, etc.)"

          echo "5. No extra whitespace or newlines in the secret values"

 

      - name: Verify credentials are set correctly

        run: |

          echo "=== Verifying credentials are set ==="

          if [ -n "$AWS_ACCESS_KEY_ID" ]; then

            echo "✅ AWS_ACCESS_KEY_ID is set (length: ${#AWS_ACCESS_KEY_ID} chars)"

            echo "   Preview: ${AWS_ACCESS_KEY_ID:0:4}...${AWS_ACCESS_KEY_ID: -4}"

          else

            echo "❌ AWS_ACCESS_KEY_ID is NOT set"

          fi

          if [ -n "$AWS_SECRET_ACCESS_KEY" ]; then

            echo "✅ AWS_SECRET_ACCESS_KEY is set (length: ${#AWS_SECRET_ACCESS_KEY} chars)"

          else

            echo "❌ AWS_SECRET_ACCESS_KEY is NOT set"

          fi

          if [ -n "$AWS_SESSION_TOKEN" ]; then

            echo "✅ AWS_SESSION_TOKEN is set (length: ${#AWS_SESSION_TOKEN} chars)"

            echo "   Token preview: ${AWS_SESSION_TOKEN:0:20}...${AWS_SESSION_TOKEN: -10}"

          else

            echo "ℹ️  AWS_SESSION_TOKEN is NOT set (using long-term credentials)"

          fi

          echo "Region: ${AWS_DEFAULT_REGION:-'not set'}"

 

      - name: Initialize Packer

        run: packer init aws-golden-image.pkr.hcl

 

      - name: Validate Packer template

        run: packer validate aws-golden-image.pkr.hcl

 

  build:

    name: Build AMI

    needs: validate

    runs-on: terraform

    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')

    permissions:

      contents: read

    steps:

      - name: Checkout code

        uses: actions/checkout@v4

 

      - name: Install dependencies

        run: |

          # Check if packages are already installed

          if command -v jq >/dev/null 2>&1 && command -v unzip >/dev/null 2>&1 && command -v curl >/dev/null 2>&1; then

            echo "All required packages (jq, unzip, curl) are already installed"

            jq --version

            unzip -v | head -1

            curl --version | head -1

          else

            echo "Some packages missing, attempting installation..."

            # Try to install missing packages, but don't fail if dnf has issues

            dnf install -y jq unzip curl 2>&1 || {

              echo "dnf install encountered issues, checking what's available..."

              # Install jq manually if needed and dnf failed

              if ! command -v jq >/dev/null 2>&1; then

                echo "Installing jq from GitHub releases..."

                curl -L https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64 -o /tmp/jq

                chmod +x /tmp/jq

                mv /tmp/jq /usr/local/bin/jq || mv /tmp/jq ~/bin/jq || cp /tmp/jq ./jq

              fi

            }

            # Verify what we have

            echo "Final status:"

            command -v jq && jq --version || echo "jq: not available"

            command -v unzip && unzip -v | head -1 || echo "unzip: not available"

            command -v curl && curl --version | head -1 || echo "curl: not available"

          fi

 

      - name: Setup Packer

        run: |

          PACKER_VERSION="1.10.0"

          # Download and install Packer

          curl -fsSL https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip -o packer.zip

          unzip -q packer.zip

          mv packer /usr/local/bin/

          rm packer.zip

          packer version

 

      - name: Clear AWS credential caches

        run: |

          echo "=== Clearing potential AWS credential caches ==="

          # Clear AWS CLI cache (if AWS CLI is installed)

          rm -rf ~/.aws/cli/cache 2>/dev/null || true

          rm -rf ~/.aws/sso/cache 2>/dev/null || true

          rm -rf ~/.aws/credentials 2>/dev/null || true

          rm -rf ~/.aws/config 2>/dev/null || true

          # Unset any existing AWS environment variables to ensure fresh credentials

          unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_SECURITY_TOKEN AWS_DEFAULT_REGION AWS_REGION || true

          echo "✅ Caches cleared"

 

      - name: Configure AWS Credentials

        run: |

          # Verify secrets are configured (before setting to GITHUB_ENV)

          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then

            echo "ERROR: AWS_ACCESS_KEY_ID secret is not configured in GitHub Secrets."

            echo "Please go to Settings > Secrets and variables > Actions and add AWS_ACCESS_KEY_ID"

            exit 1

          fi

          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then

            echo "ERROR: AWS_SECRET_ACCESS_KEY secret is not configured in GitHub Secrets."

            echo "Please go to Settings > Secrets and variables > Actions and add AWS_SECRET_ACCESS_KEY"

            exit 1

          fi

          # Trim whitespace and set AWS credentials as environment variables for subsequent steps

          ACCESS_KEY=$(echo "${{ secrets.AWS_ACCESS_KEY_ID }}" | xargs)

          SECRET_KEY=$(echo "${{ secrets.AWS_SECRET_ACCESS_KEY }}" | xargs)

          SESSION_TOKEN=$(echo "${{ secrets.AWS_SESSION_TOKEN }}" | xargs)

          echo "AWS_ACCESS_KEY_ID=${ACCESS_KEY}" >> $GITHUB_ENV

          echo "AWS_SECRET_ACCESS_KEY=${SECRET_KEY}" >> $GITHUB_ENV

          # AWS SSO and temporary credentials require AWS_SESSION_TOKEN

          if [ -n "${{ secrets.AWS_SESSION_TOKEN }}" ] && [ -n "${SESSION_TOKEN}" ]; then

            echo "AWS_SESSION_TOKEN=${SESSION_TOKEN}" >> $GITHUB_ENV

            echo "✅ AWS SSO/temporary credentials detected (with session token)"

          else

            echo "ℹ️  No AWS_SESSION_TOKEN provided - using long-term credentials"

          fi

          echo "AWS_DEFAULT_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV

          echo "AWS_REGION=${{ env.PKR_VAR_aws_region }}" >> $GITHUB_ENV

          # Basic format validation (without exposing values)

          ACCESS_KEY_LEN=${#ACCESS_KEY}

          SECRET_KEY_LEN=${#SECRET_KEY}

          if [ $ACCESS_KEY_LEN -lt 16 ] || [ $ACCESS_KEY_LEN -gt 128 ]; then

            echo "WARNING: AWS_ACCESS_KEY_ID length is ${ACCESS_KEY_LEN} characters (expected 16-128)"

            echo "This may indicate an invalid or incorrectly formatted access key"

          fi

          if [ $SECRET_KEY_LEN -lt 40 ]; then

            echo "WARNING: AWS_SECRET_ACCESS_KEY length is ${SECRET_KEY_LEN} characters (expected 40+)"

            echo "This may indicate an invalid or incorrectly formatted secret key"

          fi

          echo "✅ AWS credentials configured successfully"

          echo "AWS Region: ${{ env.PKR_VAR_aws_region }}"

          echo "Note: Credentials will be validated by Packer during execution"

          echo ""

          echo "If you see 'InvalidClientTokenId' errors, please verify:"

          echo "1. AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY secrets are set correctly"

          echo "2. For AWS SSO: AWS_SESSION_TOKEN secret is also set (required for SSO credentials)"

          echo "3. Credentials are active and not expired (SSO tokens expire after ~1 hour)"

          echo "4. IAM user/role has required permissions (ec2:DescribeImages, ec2:RunInstances, etc.)"

          echo "5. No extra whitespace or newlines in the secret values"

 

      - name: Verify credentials are set correctly

        run: |

          echo "=== Verifying credentials are set ==="

          if [ -n "$AWS_ACCESS_KEY_ID" ]; then

            echo "✅ AWS_ACCESS_KEY_ID is set (length: ${#AWS_ACCESS_KEY_ID} chars)"

            echo "   Preview: ${AWS_ACCESS_KEY_ID:0:4}...${AWS_ACCESS_KEY_ID: -4}"

          else

            echo "❌ AWS_ACCESS_KEY_ID is NOT set"

          fi

          if [ -n "$AWS_SECRET_ACCESS_KEY" ]; then

            echo "✅ AWS_SECRET_ACCESS_KEY is set (length: ${#AWS_SECRET_ACCESS_KEY} chars)"

          else

            echo "❌ AWS_SECRET_ACCESS_KEY is NOT set"

          fi

          if [ -n "$AWS_SESSION_TOKEN" ]; then

            echo "✅ AWS_SESSION_TOKEN is set (length: ${#AWS_SESSION_TOKEN} chars)"

            echo "   Token preview: ${AWS_SESSION_TOKEN:0:20}...${AWS_SESSION_TOKEN: -10}"

          else

            echo "ℹ️  AWS_SESSION_TOKEN is NOT set (using long-term credentials)"

          fi

          echo "Region: ${AWS_DEFAULT_REGION:-'not set'}"

 

      - name: Install AWS Session Manager Plugin

        run: |

          echo "=== Installing AWS Session Manager Plugin ==="

          # Check if session-manager-plugin is already installed

          if command -v session-manager-plugin >/dev/null 2>&1; then

            echo "Session Manager Plugin is already installed:"

            session-manager-plugin --version

          else

            echo "Installing Session Manager Plugin..."

            # Download Session Manager Plugin for Linux

            PLUGIN_URL="https://s3.amazonaws.com/session-manager-downloads/plugin/latest/linux_64bit/session-manager-plugin.rpm"

            curl -f -o /tmp/session-manager-plugin.rpm "$PLUGIN_URL" || {

              echo "❌ Failed to download Session Manager Plugin"

              exit 1

            }

            # Extract RPM manually (doesn't require RPM database or sudo)

            cd /tmp

            EXTRACTED=false

            # Method 1: Try rpm2cpio and cpio (preferred method)

            if command -v rpm2cpio >/dev/null 2>&1 && command -v cpio >/dev/null 2>&1; then

              echo "Extracting RPM package using rpm2cpio..."

              if rpm2cpio session-manager-plugin.rpm | cpio -idmv >/dev/null 2>&1; then

                EXTRACTED=true

                echo "✅ Extraction successful using rpm2cpio"

              else

                echo "⚠️  rpm2cpio extraction failed, trying alternative method..."

              fi

            fi

            # Method 2: Try ar and tar (alternative method - RPM files are AR archives)

            if [ "$EXTRACTED" = false ] && command -v ar >/dev/null 2>&1 && command -v tar >/dev/null 2>&1; then

              echo "Extracting RPM package using ar and tar..."

              # Try different compression formats

              if ar p session-manager-plugin.rpm data.tar.gz 2>/dev/null | tar -xz 2>/dev/null; then

                EXTRACTED=true

                echo "✅ Extraction successful using ar and tar (gzip)"

              elif ar p session-manager-plugin.rpm data.tar.xz 2>/dev/null | tar -xJ 2>/dev/null; then

                EXTRACTED=true

                echo "✅ Extraction successful using ar and tar (xz)"

              elif ar p session-manager-plugin.rpm data.tar.bz2 2>/dev/null | tar -xj 2>/dev/null; then

                EXTRACTED=true

                echo "✅ Extraction successful using ar and tar (bzip2)"

              elif ar p session-manager-plugin.rpm data.tar 2>/dev/null | tar -x 2>/dev/null; then

                EXTRACTED=true

                echo "✅ Extraction successful using ar and tar (uncompressed)"

              else

                echo "⚠️  ar/tar extraction failed"

              fi

            fi

            if [ "$EXTRACTED" = false ]; then

              echo "❌ No extraction tools available or extraction failed"

              echo "   Available tools:"

              command -v rpm2cpio >/dev/null 2>&1 && echo "   - rpm2cpio: yes" || echo "   - rpm2cpio: no"

              command -v cpio >/dev/null 2>&1 && echo "   - cpio: yes" || echo "   - cpio: no"

              command -v ar >/dev/null 2>&1 && echo "   - ar: yes" || echo "   - ar: no"

              command -v tar >/dev/null 2>&1 && echo "   - tar: yes" || echo "   - tar: no"

              exit 1

            fi

            # Find the extracted binary

            if [ -f usr/local/sessionmanagerplugin/bin/session-manager-plugin ]; then

              # Create user bin directory if it doesn't exist

              mkdir -p ~/bin

              # Copy to user bin directory (no sudo required)

              cp usr/local/sessionmanagerplugin/bin/session-manager-plugin ~/bin/

              # Make executable

              chmod +x ~/bin/session-manager-plugin

              echo "✅ Installed to ~/bin/"

            else

              echo "❌ Failed to find extracted binary after extraction"

              echo "   Checking extracted contents..."

              find . -name "session-manager-plugin" -type f 2>/dev/null || echo "   Binary not found"

              echo "   Listing extracted files:"

              ls -la usr/local/sessionmanagerplugin/bin/ 2>/dev/null || echo "   Directory not found"

              exit 1

            fi

            # Clean up

            rm -rf /tmp/session-manager-plugin.rpm /tmp/usr 2>/dev/null || true

            # Verify installation (use full path since PATH might not be updated yet)

            if [ -x ~/bin/session-manager-plugin ]; then

              ~/bin/session-manager-plugin --version

              echo "✅ Session Manager Plugin installed successfully"

              # Add to PATH for subsequent steps

              echo "$HOME/bin" >> $GITHUB_PATH

            else

              echo "❌ Failed to install Session Manager Plugin"

              echo "   Binary not found or not executable"

              exit 1

            fi

          fi

 

      - name: Initialize Packer

        run: packer init aws-golden-image.pkr.hcl

 

      - name: Build Packer image

        run: |

          PACKER_BUILD_CMD="packer build \

            -var=\"aws_region=${{ env.PKR_VAR_aws_region }}\""

          # Add IAM instance profile variable if provided

          if [ -n "${{ env.PKR_VAR_iam_instance_profile }}" ]; then

          PACKER_BUILD_CMD="${PACKER_BUILD_CMD} -var=\"iam_instance_profile=${{ env.PKR_VAR_iam_instance_profile }}\""

          echo "Using IAM Instance Profile: ${{ env.PKR_VAR_iam_instance_profile }}"

          fi

          # Add VPC and subnet variables if provided

          # Note: If subnet_id is provided, vpc_id should also be provided

          if [ -n "${{ env.PKR_VAR_vpc_id }}" ]; then

            PACKER_BUILD_CMD="${PACKER_BUILD_CMD} -var=\"vpc_id=${{ env.PKR_VAR_vpc_id }}\""

            echo "Using VPC ID: ${{ env.PKR_VAR_vpc_id }}"

          fi

          if [ -n "${{ env.PKR_VAR_subnet_id }}" ]; then

            PACKER_BUILD_CMD="${PACKER_BUILD_CMD} -var=\"subnet_id=${{ env.PKR_VAR_subnet_id }}\""

            echo "Using Subnet ID: ${{ env.PKR_VAR_subnet_id }}"

          fi

          # Add security group IDs if provided (comma-separated string converted to HCL list)

          # Note: We read directly from vars.SECURITY_GROUP_IDS to avoid Packer parsing env vars

          # Packer expects HCL list syntax: ["sg-123","sg-456"]

          SECURITY_GROUP_IDS="${{ vars.SECURITY_GROUP_IDS }}"

          if [ -n "$SECURITY_GROUP_IDS" ] && [ "$SECURITY_GROUP_IDS" != "" ]; then

            # Convert comma-separated string to HCL list format

            # Split by comma, trim spaces, wrap each in quotes, join with commas, wrap in brackets

            SG_IDS="$SECURITY_GROUP_IDS"

            # Create HCL list format: ["sg-123","sg-456"]

            # Process each security group ID

            SG_HCL=$(echo "$SG_IDS" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed 's/^/"/;s/$/"/' | tr '\n' ',' | sed 's/,$//' | sed 's/^/[/;s/$/]/')

            # Write to a temporary var file to avoid shell quoting issues

            # Packer requires var files to have .hcl or .json extension

            VAR_FILE=$(mktemp --suffix=.hcl)

            echo "security_group_ids = $SG_HCL" > "$VAR_FILE"

            PACKER_BUILD_CMD="${PACKER_BUILD_CMD} -var-file=$VAR_FILE"

            echo "Using Security Group IDs: $SECURITY_GROUP_IDS"

            echo "HCL format: $SG_HCL"

            echo "Var file content:"

            cat "$VAR_FILE"

          fi

          PACKER_BUILD_CMD="${PACKER_BUILD_CMD} aws-golden-image.pkr.hcl"

          eval $PACKER_BUILD_CMD

 

      - name: Output AMI ID

        if: success()

        run: |

          echo "AMI build completed successfully!"

          echo "Check AWS EC2 Console for the latest AMI"