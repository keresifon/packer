---
# CIS 6.2 - User and Group Settings (Level 2)
# Configures user and group security settings

- name: Ensure password expiration is 365 days or less (Level 2)
  lineinfile:
    path: /etc/login.defs
    regexp: '^PASS_MAX_DAYS'
    line: 'PASS_MAX_DAYS 365'
  when: (cis_level | default(cis_level_default) | int) >= 2

- name: Ensure minimum days between password changes is 7 (Level 2)
  lineinfile:
    path: /etc/login.defs
    regexp: '^PASS_MIN_DAYS'
    line: 'PASS_MIN_DAYS 7'
  when: (cis_level | default(cis_level_default) | int) >= 2

- name: Ensure password expiration warning days is 7 (Level 2)
  lineinfile:
    path: /etc/login.defs
    regexp: '^PASS_WARN_AGE'
    line: 'PASS_WARN_AGE 7'
  when: (cis_level | default(cis_level_default) | int) >= 2

- name: Ensure inactive password lock is 30 days or less (Level 2)
  lineinfile:
    path: /etc/default/useradd
    regexp: '^INACTIVE='
    line: 'INACTIVE=30'
  when: (cis_level | default(cis_level_default) | int) >= 2

- name: Ensure default group for the root account is GID 0 (Level 2)
  user:
    name: root
    group: root
  when: (cis_level | default(cis_level_default) | int) >= 2

- name: Ensure default user umask is 027 or more restrictive (Level 2)
  lineinfile:
    path: /etc/login.defs
    regexp: '^UMASK'
    line: 'UMASK 027'
  when: (cis_level | default(cis_level_default) | int) >= 2

- name: Ensure default user shell timeout is configured (Level 2) (Ubuntu/Debian)
  lineinfile:
    path: /etc/bash.bashrc
    regexp: '^TMOUT='
    line: 'TMOUT=600'
    insertafter: '^# If not running interactively'
  when:
    - (cis_level | default(cis_level_default) | int) >= 2
    - ansible_os_family == "Debian"

- name: Ensure default user shell timeout is configured (Level 2) (Amazon Linux/RHEL)
  lineinfile:
    path: /etc/bashrc
    regexp: '^TMOUT='
    line: 'TMOUT=600'
    insertafter: '^# System wide functions and aliases'
  when:
    - (cis_level | default(cis_level_default) | int) >= 2
    - ansible_os_family == "RedHat"

- name: Ensure default user shell timeout is configured in profile (Level 2)
  lineinfile:
    path: /etc/profile
    regexp: '^TMOUT='
    line: 'TMOUT=600'
    insertafter: '^# If not running interactively'
  when: (cis_level | default(cis_level_default) | int) >= 2

