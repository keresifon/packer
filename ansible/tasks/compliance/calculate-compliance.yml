---
# Calculate compliance statistics from all checks
# This task should be included after all compliance checks have run

- name: Extract PASS/FAIL from multi-line outputs
  set_fact:
    rsyslog_status: "{{ 'PASS' if 'PASS' in rsyslog_check.stdout_lines else ('FAIL' if 'FAIL' in rsyslog_check.stdout_lines else rsyslog_check.stdout) }}"
    timesync_status: "{{ 'PASS' if 'PASS' in timesync_check.stdout_lines else ('FAIL' if 'FAIL' in timesync_check.stdout_lines else timesync_check.stdout) }}"

- name: Calculate compliance percentage
  set_fact:
    compliance_checks_base:
      - "{{ cramfs_check.stdout }}"
      - "{{ bootloader_check.stdout | default('PASS') }}"
      - "{{ coredump_check.stdout }}"
      - "{{ aslr_check.stdout }}"
      - "{{ mac_check_result | default('FAIL') }}"
      - "{{ ip_forward_check.stdout }}"
      - "{{ syn_cookies_check.stdout }}"
      - "{{ rsyslog_status }}"
      - "{{ timesync_status }}"
      - "{{ passwd_perm_check.stdout }}"
    compliance_checks_level2: "{{ [] }}"
    compliance_checks_detailed_base:
      - { name: "CIS 1.1.1.1 - cramfs disabled", status: "{{ cramfs_check.stdout }}" }
      - { name: "CIS 1.4 - Bootloader password protection", status: "{{ bootloader_check.stdout | default('PASS') }}" }
      - { name: "CIS 1.5.1 - Core dumps restricted", status: "{{ coredump_check.stdout }}" }
      - { name: "CIS 1.5.3 - ASLR enabled", status: "{{ aslr_check.stdout }}" }
      - { name: "CIS 1.6.1.1 - MAC installed (AppArmor/SELinux)", status: "{{ mac_check_result | default('FAIL') }}" }
      - { name: "CIS 3.1.1 - IP forwarding disabled", status: "{{ ip_forward_check.stdout }}" }
      - { name: "CIS 3.1.2 - SYN cookies enabled", status: "{{ syn_cookies_check.stdout }}" }
      - { name: "CIS 4.1 - rsyslog configured", status: "{{ rsyslog_status }}" }
      - { name: "CIS 5.1 - Time synchronization configured", status: "{{ timesync_status }}" }
      - { name: "CIS 6.1.1 - /etc/passwd permissions", status: "{{ passwd_perm_check.stdout }}" }
    compliance_checks_detailed_level2: "{{ [] }}"

- name: Build Level 2 compliance checks list
  set_fact:
    compliance_checks_level2: "{{ compliance_checks_level2 + [item.status] }}"
    compliance_checks_detailed_level2: "{{ compliance_checks_detailed_level2 + [item] }}"
  loop:
    - { name: "CIS 5.2.1 - SSH Protocol version 2", status: "{{ ssh_protocol_check.stdout | default('SKIP') }}" }
    - { name: "CIS 5.2.2 - SSH LogLevel INFO", status: "{{ ssh_loglevel_check.stdout | default('SKIP') }}" }
    - { name: "CIS 5.2.3 - SSH X11Forwarding disabled", status: "{{ ssh_x11_check.stdout | default('SKIP') }}" }
    - { name: "CIS 6.2.1 - PASS_MAX_DAYS configured", status: "{{ pass_max_days_check.stdout | default('SKIP') }}" }
    - { name: "CIS 6.2.2 - PASS_MIN_DAYS configured", status: "{{ pass_min_days_check.stdout | default('SKIP') }}" }
    - { name: "CIS 6.3.1 - cron.d permissions", status: "{{ cron_d_perm_check.stdout | default('SKIP') }}" }
  when: (cis_level | default(cis_level_default) | int) >= 2
  loop_control:
    label: "{{ item.name }}"

- name: Combine all compliance checks
  set_fact:
    compliance_checks: "{{ compliance_checks_base + (compliance_checks_level2 | select('ne', 'SKIP') | list) }}"
    compliance_checks_detailed: "{{ compliance_checks_detailed_base + (compliance_checks_detailed_level2 | selectattr('status', 'ne', 'SKIP') | list) }}"

- name: Calculate compliance statistics
  set_fact:
    compliance_passed: "{{ compliance_checks | select('equalto', 'PASS') | list | length }}"
    compliance_total: "{{ compliance_checks | length }}"
    compliance_failed_checks: "{{ compliance_checks_detailed | selectattr('status', 'equalto', 'FAIL') | map(attribute='name') | list }}"

- name: Calculate compliance percentage
  set_fact:
    compliance_percentage: "{{ ((compliance_passed | int / compliance_total | int) * 100) | int }}"

