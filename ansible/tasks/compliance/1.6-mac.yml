---
# CIS 1.6 Compliance Checks - Mandatory Access Control
# Supports Ubuntu 22.04 LTS (AppArmor) and Amazon Linux 2023 (SELinux)

- name: Check CIS 1.6.1.1 - AppArmor installed (Ubuntu/Debian)
  command: which apparmor_status
  register: apparmor_check
  failed_when: false
  changed_when: false
  when: ansible_os_family == "Debian"

- name: Check CIS 1.6.1.1 - SELinux installed (Amazon Linux/RHEL)
  command: which getenforce
  register: selinux_check
  failed_when: false
  changed_when: false
  when: ansible_os_family == "RedHat"

- name: Check CIS 1.6.1.1 - SELinux status (Amazon Linux/RHEL)
  command: getenforce
  register: selinux_status_check
  failed_when: false
  changed_when: false
  when: ansible_os_family == "RedHat"

- name: Set MAC check result for Ubuntu/Debian
  set_fact:
    mac_check_result: "{{ 'PASS' if apparmor_check.rc == 0 else 'FAIL' }}"
  when: ansible_os_family == "Debian"

- name: Set MAC check result for Amazon Linux/RHEL
  set_fact:
    mac_check_result: "{{ 'PASS' if (selinux_check.rc == 0 and selinux_status_check.stdout | upper == 'ENFORCING') else 'FAIL' }}"
  when: ansible_os_family == "RedHat"
