---
# CIS Ubuntu 22.04 LTS Benchmark Hardening Playbook
# This playbook applies CIS benchmark recommendations using Ansible

- name: CIS Ubuntu 22.04 LTS Benchmark Hardening
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    # CIS Benchmark Level (1 = Level 1, 2 = Level 2)
    # Default to 2 if not provided, and ensure it's an integer
    cis_level_default: 2
    
    # Skip specific CIS sections if needed (empty list = apply all)
    cis_skip_sections: []
    
    # Compliance threshold (fail build if below this percentage)
    cis_compliance_threshold: 80

  pre_tasks:
    - name: Convert cis_level to integer (handle string from Packer)
      set_fact:
        cis_level: "{{ (cis_level | default(cis_level_default)) | int }}"

    - name: Ensure Python is available
      raw: test -e /usr/bin/python3 || (apt-get update && apt-get install -y python3)
      changed_when: false

    - name: Install required system packages
      apt:
        name:
          - python3-pip
          - python3-setuptools
          - git
        state: present
        update_cache: yes

  tasks:
    # Option 1: Use dev-sec CIS role (if available)
    # - name: Apply CIS Ubuntu 22.04 Benchmark
    #   include_role:
    #     name: devsec.cis_ubuntu_22_04
    #   vars:
    #     cis_level: "{{ cis_level }}"

    # Option 2: Manual CIS hardening tasks
    - name: CIS 1.1 - Filesystem Configuration
      block:
        - name: Disable cramfs filesystem
          modprobe:
            name: cramfs
            state: absent
            params: install /bin/true
          ignore_errors: yes
          register: cramfs_result

        - name: Blacklist cramfs
          lineinfile:
            path: /etc/modprobe.d/CIS.conf
            line: "install cramfs /bin/true"
            create: yes
            state: present

        - name: Note if cramfs is builtin
          debug:
            msg: "cramfs is built into kernel (cannot be disabled via modprobe)"
          when: cramfs_result.failed and "'builtin' in cramfs_result.msg | default('')"

        - name: Disable squashfs filesystem
          modprobe:
            name: squashfs
            state: absent
            params: install /bin/true
          ignore_errors: yes
          register: squashfs_result

        - name: Blacklist squashfs
          lineinfile:
            path: /etc/modprobe.d/CIS.conf
            line: "install squashfs /bin/true"
            create: yes
            state: present

        - name: Note if squashfs is builtin
          debug:
            msg: "squashfs is built into kernel (cannot be disabled via modprobe, blacklisted in modprobe.d)"
          when: squashfs_result.failed and "'builtin' in squashfs_result.msg | default('')"

        - name: Disable udf filesystem
          modprobe:
            name: udf
            state: absent
            params: install /bin/true
          ignore_errors: yes
          register: udf_result

        - name: Blacklist udf
          lineinfile:
            path: /etc/modprobe.d/CIS.conf
            line: "install udf /bin/true"
            create: yes
            state: present

        - name: Note if udf is builtin
          debug:
            msg: "udf is built into kernel (cannot be disabled via modprobe, blacklisted in modprobe.d)"
          when: udf_result.failed and "'builtin' in udf_result.msg | default('')"

        # Level 2: Additional filesystem restrictions
        - name: Disable freevxfs filesystem (Level 2)
          modprobe:
            name: freevxfs
            state: absent
            params: install /bin/true
          ignore_errors: yes
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Blacklist freevxfs (Level 2)
          lineinfile:
            path: /etc/modprobe.d/CIS.conf
            line: "install freevxfs /bin/true"
            create: yes
            state: present
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Disable jffs2 filesystem (Level 2)
          modprobe:
            name: jffs2
            state: absent
            params: install /bin/true
          ignore_errors: yes
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Blacklist jffs2 (Level 2)
          lineinfile:
            path: /etc/modprobe.d/CIS.conf
            line: "install jffs2 /bin/true"
            create: yes
            state: present
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Disable hfs filesystem (Level 2)
          modprobe:
            name: hfs
            state: absent
            params: install /bin/true
          ignore_errors: yes
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Blacklist hfs (Level 2)
          lineinfile:
            path: /etc/modprobe.d/CIS.conf
            line: "install hfs /bin/true"
            create: yes
            state: present
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Disable hfsplus filesystem (Level 2)
          modprobe:
            name: hfsplus
            state: absent
            params: install /bin/true
          ignore_errors: yes
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Blacklist hfsplus (Level 2)
          lineinfile:
            path: /etc/modprobe.d/CIS.conf
            line: "install hfsplus /bin/true"
            create: yes
            state: present
          when: (cis_level | default(cis_level_default) | int) >= 2

    - name: CIS 1.4 - Secure Boot Settings
      block:
        - name: Set bootloader config permissions
          file:
            path: /boot/grub/grub.cfg
            owner: root
            group: root
            mode: '0600'
          when: ansible_facts['os_family'] == "Debian"

    - name: CIS 1.5 - Additional Process Hardening
      block:
        - name: Restrict core dumps
          lineinfile:
            path: /etc/security/limits.conf
            line: '* hard core 0'
            regexp: '^\* hard core'
            state: present

        - name: Disable suid_dumpable
          sysctl:
            name: fs.suid_dumpable
            value: '0'
            state: present
            sysctl_set: yes
            reload: yes

        - name: Enable ASLR
          sysctl:
            name: kernel.randomize_va_space
            value: '2'
            state: present
            sysctl_set: yes
            reload: yes

        # Level 2: Additional process hardening
        - name: Restrict access to kernel dmesg (Level 2)
          sysctl:
            name: kernel.dmesg_restrict
            value: '1'
            state: present
            sysctl_set: yes
            reload: yes
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Enable kernel unprivileged bpf disabled (Level 2)
          sysctl:
            name: kernel.unprivileged_bpf_disabled
            value: '1'
            state: present
            sysctl_set: yes
            reload: yes
          when: (cis_level | default(cis_level_default) | int) >= 2

    - name: CIS 1.6 - Mandatory Access Control
      block:
        - name: Install AppArmor
          apt:
            name:
              - apparmor
              - apparmor-utils
            state: present

        - name: Enable AppArmor in bootloader
          lineinfile:
            path: /etc/default/grub
            regexp: '^GRUB_CMDLINE_LINUX='
            line: 'GRUB_CMDLINE_LINUX="apparmor=1 security=apparmor"'
            backup: yes

        - name: Update grub configuration
          command: update-grub
          when: ansible_facts['os_family'] == "Debian"

    - name: CIS 1.7 - Command Line Warning Banners
      block:
        - name: Configure local login warning banner
          copy:
            content: "Authorized uses only. All activity may be monitored and reported.\n"
            dest: /etc/issue
            owner: root
            group: root
            mode: '0644'

        - name: Configure remote login warning banner
          copy:
            content: "Authorized uses only. All activity may be monitored and reported.\n"
            dest: /etc/issue.net
            owner: root
            group: root
            mode: '0644'

        # Level 2: Additional banner requirements
        - name: Ensure GDM login banner is configured (Level 2)
          blockinfile:
            path: /etc/dconf/profile/gdm
            block: |
              user-db:user
              system-db:gdm
              file-db:/usr/share/gdm/greeter-dconf-defaults
            create: yes
            marker: "# {mark} ANSIBLE MANAGED BLOCK"
          when: (cis_level | default(cis_level_default) | int) >= 2
          ignore_errors: yes

    - name: CIS 2.1 - Services
      block:
        - name: Remove xinetd
          apt:
            name: xinetd
            state: absent

        - name: Remove xorg-x11-server-common
          apt:
            name: xorg-x11-server-common
            state: absent

    - name: CIS 2.2 - Special Purpose Services
      block:
        - name: Remove NIS client
          apt:
            name: nis
            state: absent

        - name: Remove rsh client
          apt:
            name: rsh-client
            state: absent

        - name: Remove talk client
          apt:
            name: talk
            state: absent

        - name: Remove telnet client
          apt:
            name: telnet
            state: absent

        - name: Remove LDAP client
          apt:
            name: ldap-utils
            state: absent

        # Level 2: Additional service removals
        - name: Remove RPC (Level 2)
          apt:
            name: rpcbind
            state: absent
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Remove Avahi server (Level 2)
          apt:
            name: avahi-daemon
            state: absent
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Remove CUPS (Level 2)
          apt:
            name: cups
            state: absent
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Remove DHCP server (Level 2)
          apt:
            name: isc-dhcp-server
            state: absent
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Remove DNS server (Level 2)
          apt:
            name: bind9
            state: absent
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Remove FTP server (Level 2)
          apt:
            name: vsftpd
            state: absent
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Remove HTTP server (Level 2)
          apt:
            name: apache2
            state: absent
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Remove IMAP and POP3 server (Level 2)
          apt:
            name:
              - dovecot-imapd
              - dovecot-pop3d
            state: absent
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Remove Samba (Level 2)
          apt:
            name: samba
            state: absent
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Remove HTTP proxy server (Level 2)
          apt:
            name: squid
            state: absent
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Remove SNMP server (Level 2)
          apt:
            name: snmpd
            state: absent
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Remove NIS server (Level 2)
          apt:
            name: nis
            state: absent
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Remove rsh server (Level 2)
          apt:
            name: rsh-server
            state: absent
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Remove rsync server (Level 2)
          apt:
            name: rsync
            state: absent
          when: (cis_level | default(cis_level_default) | int) >= 2

    - name: CIS 3.1 - Network Parameters
      block:
        - name: Disable IP forwarding (IPv4)
          sysctl:
            name: net.ipv4.ip_forward
            value: '0'
            state: present
            sysctl_set: yes
            reload: yes

        - name: Disable IP forwarding (IPv6)
          sysctl:
            name: net.ipv6.conf.all.forwarding
            value: '0'
            state: present
            sysctl_set: yes
            reload: yes

        - name: Disable packet redirect sending
          sysctl:
            name: "{{ item }}"
            value: '0'
            state: present
            sysctl_set: yes
            reload: yes
          loop:
            - net.ipv4.conf.all.send_redirects
            - net.ipv4.conf.default.send_redirects

        - name: Disable source routed packets
          sysctl:
            name: "{{ item }}"
            value: '0'
            state: present
            sysctl_set: yes
            reload: yes
          loop:
            - net.ipv4.conf.all.accept_source_route
            - net.ipv4.conf.default.accept_source_route

        - name: Disable ICMP redirects
          sysctl:
            name: "{{ item }}"
            value: '0'
            state: present
            sysctl_set: yes
            reload: yes
          loop:
            - net.ipv4.conf.all.accept_redirects
            - net.ipv4.conf.default.accept_redirects

        - name: Enable TCP SYN Cookies
          sysctl:
            name: net.ipv4.tcp_syncookies
            value: '1'
            state: present
            sysctl_set: yes
            reload: yes

        # Level 2: Additional network hardening
        - name: Enable IP spoofing protection (Level 2)
          sysctl:
            name: "{{ item }}"
            value: '1'
            state: present
            sysctl_set: yes
            reload: yes
          loop:
            - net.ipv4.conf.all.rp_filter
            - net.ipv4.conf.default.rp_filter
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Disable IPv6 if not needed (Level 2)
          sysctl:
            name: net.ipv6.conf.all.disable_ipv6
            value: '1'
            state: present
            sysctl_set: yes
            reload: yes
          when: (cis_level | default(cis_level_default) | int) >= 2
          # Note: Comment out if IPv6 is required

        - name: Enable TCP timestamps (Level 2)
          sysctl:
            name: net.ipv4.tcp_timestamps
            value: '1'
            state: present
            sysctl_set: yes
            reload: yes
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Enable ICMP echo ignore broadcasts (Level 2)
          sysctl:
            name: net.ipv4.icmp_echo_ignore_broadcasts
            value: '1'
            state: present
            sysctl_set: yes
            reload: yes
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Enable ICMP ignore bogus error responses (Level 2)
          sysctl:
            name: net.ipv4.icmp_ignore_bogus_error_responses
            value: '1'
            state: present
            sysctl_set: yes
            reload: yes
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Enable log martians (Level 2)
          sysctl:
            name: "{{ item }}"
            value: '1'
            state: present
            sysctl_set: yes
            reload: yes
          loop:
            - net.ipv4.conf.all.log_martians
            - net.ipv4.conf.default.log_martians
          when: (cis_level | default(cis_level_default) | int) >= 2

    - name: CIS 4.1 - Configure Logging
      block:
        - name: Install rsyslog
          apt:
            name: rsyslog
            state: present

        - name: Enable rsyslog service
          systemd:
            name: rsyslog
            enabled: yes
            state: started

        # Level 2: Enhanced logging configuration
        - name: Configure rsyslog to send logs to remote log host (Level 2)
          blockinfile:
            path: /etc/rsyslog.conf
            block: |
              # Send all logs to remote log host (Level 2)
              # Uncomment and configure if remote logging is required
              # *.* @@loghost.example.com
            marker: "# {mark} ANSIBLE MANAGED BLOCK - CIS Level 2"
          when: (cis_level | default(cis_level_default) | int) >= 2
          # Note: Configure actual log host as needed

        - name: Ensure rsyslog default file permissions configured (Level 2)
          lineinfile:
            path: /etc/rsyslog.conf
            regexp: '^\$FileCreateMode'
            line: '$FileCreateMode 0640'
            insertafter: '^#\$FileCreateMode'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Configure journald to forward to rsyslog (Level 2)
          lineinfile:
            path: /etc/systemd/journald.conf
            regexp: '^#?ForwardToSyslog='
            line: 'ForwardToSyslog=yes'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Configure journald to store logs persistently (Level 2)
          lineinfile:
            path: /etc/systemd/journald.conf
            regexp: '^#?Storage='
            line: 'Storage=persistent'
          when: (cis_level | default(cis_level_default) | int) >= 2

    - name: CIS 5.1 - Configure Time Synchronization
      block:
        - name: Install chrony
          apt:
            name: chrony
            state: present

        - name: Enable chrony service
          systemd:
            name: chronyd
            enabled: yes
            state: started

        - name: Set timezone to UTC
          timezone:
            name: UTC

    - name: CIS 6.1 - System File Permissions
      block:
        - name: Set /etc/passwd permissions
          file:
            path: /etc/passwd
            owner: root
            group: root
            mode: '0644'

        - name: Set /etc/passwd- permissions
          file:
            path: /etc/passwd-
            owner: root
            group: root
            mode: '0600'

        - name: Set /etc/group permissions
          file:
            path: /etc/group
            owner: root
            group: root
            mode: '0644'

        - name: Set /etc/group- permissions
          file:
            path: /etc/group-
            owner: root
            group: root
            mode: '0600'

        - name: Set /etc/shadow permissions
          file:
            path: /etc/shadow
            owner: root
            group: shadow
            mode: '0000'

        - name: Set /etc/shadow- permissions
          file:
            path: /etc/shadow-
            owner: root
            group: shadow
            mode: '0000'

        - name: Set /etc/ssh/sshd_config permissions
          file:
            path: /etc/ssh/sshd_config
            owner: root
            group: root
            mode: '0600'

    # Level 2: Additional SSH hardening
    - name: CIS 5.2 - SSH Server Configuration (Level 2)
      block:
        - name: Ensure SSH Protocol is set to 2 (Level 2)
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?Protocol'
            line: 'Protocol 2'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure SSH LogLevel is set to INFO (Level 2)
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?LogLevel'
            line: 'LogLevel INFO'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure SSH X11 forwarding is disabled (Level 2)
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?X11Forwarding'
            line: 'X11Forwarding no'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure SSH MaxAuthTries is set to 4 or less (Level 2)
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?MaxAuthTries'
            line: 'MaxAuthTries 4'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure SSH IgnoreRhosts is enabled (Level 2)
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?IgnoreRhosts'
            line: 'IgnoreRhosts yes'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure SSH HostbasedAuthentication is disabled (Level 2)
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?HostbasedAuthentication'
            line: 'HostbasedAuthentication no'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure SSH root login is disabled (Level 2)
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?PermitRootLogin'
            line: 'PermitRootLogin no'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure SSH PermitEmptyPasswords is disabled (Level 2)
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?PermitEmptyPasswords'
            line: 'PermitEmptyPasswords no'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure SSH PermitUserEnvironment is disabled (Level 2)
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?PermitUserEnvironment'
            line: 'PermitUserEnvironment no'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure only approved MAC algorithms are used (Level 2)
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?MACs'
            line: 'MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure only approved ciphers are used (Level 2)
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?Ciphers'
            line: 'Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure only approved key exchange algorithms are used (Level 2)
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?KexAlgorithms'
            line: 'KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group14-sha256,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512,ecdh-sha2-nistp521,ecdh-sha2-nistp384,ecdh-sha2-nistp256,diffie-hellman-group-exchange-sha256'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure SSH Idle Timeout Interval is configured (Level 2)
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?ClientAliveInterval'
            line: 'ClientAliveInterval 300'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure SSH ClientAliveCountMax is set (Level 2)
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?ClientAliveCountMax'
            line: 'ClientAliveCountMax 0'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure SSH LoginGraceTime is set to one minute or less (Level 2)
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?LoginGraceTime'
            line: 'LoginGraceTime 60'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure SSH access is limited (Level 2)
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?AllowUsers'
            line: '# AllowUsers user1 user2'
            insertafter: '^# Example of overriding settings'
          when: (cis_level | default(cis_level_default) | int) >= 2
          # Note: Configure actual allowed users as needed

        - name: Restart SSH service after configuration changes
          systemd:
            name: sshd
            state: restarted
          when: (cis_level | default(cis_level_default) | int) >= 2

    # Level 2: Additional file permissions and access controls
    - name: CIS 6.2 - User and Group Settings (Level 2)
      block:
        - name: Ensure password expiration is 365 days or less (Level 2)
          lineinfile:
            path: /etc/login.defs
            regexp: '^PASS_MAX_DAYS'
            line: 'PASS_MAX_DAYS 365'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure minimum days between password changes is 7 (Level 2)
          lineinfile:
            path: /etc/login.defs
            regexp: '^PASS_MIN_DAYS'
            line: 'PASS_MIN_DAYS 7'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure password expiration warning days is 7 (Level 2)
          lineinfile:
            path: /etc/login.defs
            regexp: '^PASS_WARN_AGE'
            line: 'PASS_WARN_AGE 7'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure inactive password lock is 30 days or less (Level 2)
          lineinfile:
            path: /etc/default/useradd
            regexp: '^INACTIVE='
            line: 'INACTIVE=30'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure default group for the root account is GID 0 (Level 2)
          user:
            name: root
            group: root
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure default user umask is 027 or more restrictive (Level 2)
          lineinfile:
            path: /etc/login.defs
            regexp: '^UMASK'
            line: 'UMASK 027'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure default user shell timeout is configured (Level 2)
          lineinfile:
            path: /etc/bash.bashrc
            regexp: '^TMOUT='
            line: 'TMOUT=600'
            insertafter: '^# If not running interactively'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure default user shell timeout is configured in profile (Level 2)
          lineinfile:
            path: /etc/profile
            regexp: '^TMOUT='
            line: 'TMOUT=600'
            insertafter: '^# If not running interactively'
          when: (cis_level | default(cis_level_default) | int) >= 2

    # Level 2: Additional system maintenance
    - name: CIS 6.3 - System Maintenance (Level 2)
      block:
        - name: Ensure permissions on /etc/cron.allow are configured (Level 2)
          file:
            path: /etc/cron.allow
            owner: root
            group: root
            mode: '0600'
            state: touch
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure /etc/cron.deny does not exist (Level 2)
          file:
            path: /etc/cron.deny
            state: absent
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure permissions on /etc/cron.d are configured (Level 2)
          file:
            path: /etc/cron.d
            owner: root
            group: root
            mode: '0700'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure permissions on /etc/cron.daily are configured (Level 2)
          file:
            path: /etc/cron.daily
            owner: root
            group: root
            mode: '0700'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure permissions on /etc/cron.hourly are configured (Level 2)
          file:
            path: /etc/cron.hourly
            owner: root
            group: root
            mode: '0700'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure permissions on /etc/cron.monthly are configured (Level 2)
          file:
            path: /etc/cron.monthly
            owner: root
            group: root
            mode: '0700'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure permissions on /etc/cron.weekly are configured (Level 2)
          file:
            path: /etc/cron.weekly
            owner: root
            group: root
            mode: '0700'
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure at/cron is restricted to authorized users (Level 2)
          file:
            path: /etc/at.allow
            owner: root
            group: root
            mode: '0600'
            state: touch
          when: (cis_level | default(cis_level_default) | int) >= 2

        - name: Ensure /etc/at.deny does not exist (Level 2)
          file:
            path: /etc/at.deny
            state: absent
          when: (cis_level | default(cis_level_default) | int) >= 2

  post_tasks:
    - name: Display CIS hardening completion message
      debug:
        msg: "CIS Ubuntu 22.04 LTS Benchmark Level {{ cis_level }} hardening completed successfully"

