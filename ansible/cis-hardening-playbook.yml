---
# CIS Ubuntu 22.04 LTS Benchmark Hardening Playbook
# Modular version using task files
# This playbook applies CIS benchmark recommendations using Ansible

- name: CIS Ubuntu 22.04 LTS Benchmark Hardening
  hosts: all
  become: yes
  gather_facts: yes

  vars_files:
    - vars/cis-defaults.yml

  pre_tasks:
    - name: Convert cis_level to integer (handle string from Packer)
      set_fact:
        cis_level: "{{ (cis_level | default(cis_level_default)) | int }}"

    - name: Ensure Python is available
      raw: test -e /usr/bin/python3 || (apt-get update && apt-get install -y python3)
      changed_when: false

    - name: Install required system packages
      apt:
        name:
          - python3-pip
          - python3-setuptools
          - git
        state: present
        update_cache: yes

  tasks:
    - name: CIS 1.1 - Filesystem Configuration
      include_tasks: tasks/cis/1.1-filesystem.yml
      when: '1.1' not in cis_skip_sections

    - name: CIS 1.4 - Secure Boot Settings
      include_tasks: tasks/cis/1.4-boot-settings.yml
      when: '1.4' not in cis_skip_sections

    - name: CIS 1.5 - Additional Process Hardening
      include_tasks: tasks/cis/1.5-process-hardening.yml
      when: '1.5' not in cis_skip_sections

    - name: CIS 1.6 - Mandatory Access Control
      include_tasks: tasks/cis/1.6-mac.yml
      when: '1.6' not in cis_skip_sections

    - name: CIS 1.7 - Command Line Warning Banners
      include_tasks: tasks/cis/1.7-warning-banners.yml
      when: '1.7' not in cis_skip_sections

    - name: CIS 2.1 - Services
      include_tasks: tasks/cis/2.1-services.yml
      when: '2.1' not in cis_skip_sections

    - name: CIS 2.2 - Special Purpose Services
      include_tasks: tasks/cis/2.2-special-services.yml
      when: '2.2' not in cis_skip_sections

    - name: CIS 3.1 - Network Parameters
      include_tasks: tasks/cis/3.1-network.yml
      when: '3.1' not in cis_skip_sections

    - name: CIS 4.1 - Configure Logging
      include_tasks: tasks/cis/4.1-logging.yml
      when: '4.1' not in cis_skip_sections

    - name: CIS 5.1 - Configure Time Synchronization
      include_tasks: tasks/cis/5.1-time-sync.yml
      when: '5.1' not in cis_skip_sections

    - name: CIS 5.2 - SSH Server Configuration (Level 2)
      include_tasks: tasks/cis/5.2-ssh.yml
      when: '5.2' not in cis_skip_sections

    - name: CIS 6.1 - System File Permissions
      include_tasks: tasks/cis/6.1-file-permissions.yml
      when: '6.1' not in cis_skip_sections

    - name: CIS 6.2 - User and Group Settings (Level 2)
      include_tasks: tasks/cis/6.2-user-group.yml
      when: '6.2' not in cis_skip_sections

    - name: CIS 6.3 - System Maintenance (Level 2)
      include_tasks: tasks/cis/6.3-maintenance.yml
      when: '6.3' not in cis_skip_sections

  post_tasks:
    - name: Display CIS hardening completion message
      debug:
        msg: "CIS Ubuntu 22.04 LTS Benchmark Level {{ cis_level }} hardening completed successfully"
